<!doctype html>
<html lang="lv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chrome 60 Emulācijas ietvars (vienas lapas tests)</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#151a21; --muted:#9aa4b2; --text:#eef2f7; --brand:#437e12;
      --card:#11161d; --border:#232b36;
    }
    html,body{height:100%;}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial,sans-serif;}
    .wrap{display:grid;grid-template-rows:auto 1fr; height:100%;}
    header{background:var(--panel);border-bottom:1px solid var(--border);}
    .bar{display:flex;flex-wrap:wrap; gap:.75rem; align-items:center; padding:.75rem 1rem;}
    .brand{font-weight:700;letter-spacing:.2px;display:flex;align-items:center;gap:.65rem}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--brand);box-shadow:0 0 0 4px rgba(67,126,18,.35)}
    .bar input[type="text"]{flex:1 1 380px; min-width:260px; background:#0c1016; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:.6rem .8rem}
    .bar button, .bar .seg button{appearance:none;border:1px solid var(--border);background:#0e141b;color:var(--text);border-radius:10px;padding:.55rem .8rem;cursor:pointer}
    .bar button:hover{border-color:#2b3542}
    .seg{display:inline-flex;background:#0e141b;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .seg button{border:0;border-right:1px solid var(--border)}
    .seg button:last-child{border-right:0}
    .seg button[aria-pressed="true"]{background:var(--brand)}
    .chk{display:flex;align-items:center;gap:.45rem}
    .chk input{accent-color:var(--brand)}
    .help{color:var(--muted);font-size:12px;padding:0 1rem .5rem}
    .note{padding:.6rem .9rem; background:#0e1510; border:1px solid #1d2b1f; color:#cde7cf; border-radius:10px; margin:.4rem 1rem}
    .warnline{padding:.6rem .9rem; background:#15100e; border:1px solid #2b1f1d; color:#f1c9c9; border-radius:10px; margin:.4rem 1rem}

    .main{position:relative;display:grid;place-items:center;padding:10px}
    .device{position:relative;background:#0a0e13;border:1px solid var(--border);border-radius:14px;box-shadow:0 15px 40px rgba(0,0,0,.45);overflow:hidden}
    .device .frame{display:block;border:0;background:#0a0e13;width:100%;height:100%}
    .badge{position:absolute;right:10px;top:10px;font-size:12px;color:var(--muted);background:#0c1117;border:1px solid var(--border);padding:.2rem .4rem;border-radius:6px}
    .log{position:absolute;inset:auto 8px 8px auto; width:min(560px, 92vw); max-height:46vh; overflow:auto; background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); padding:.65rem .8rem; font:12px/1.4 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; display:none}
    .log h4{margin:.2rem 0 .5rem;font-size:12px;color:var(--muted)}
    .log pre{white-space:pre-wrap; word-break:break-word; margin:.1rem 0}
    .log .err{color:#ffb4b4}
    .log .warn{color:#ffd59e}
    .log .ok{color:#b7ffb7}


    html, body { max-width: 100%; overflow-x: hidden; } /* nobloķē horizontālo pārplūdi */
.main { overflow: hidden; }                         /* drošībai pret iekšējo padding */
.device { max-width: 100%; }                        /* ierobežo “ierīces” platumu */
.device .frame { width: 100%; height: 100%; display: block; } /* iframe nebīda layout */
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="bar">
        <div class="brand"><span class="dot"></span> Chrome 60 emulācija</div>
        <input id="url" type="text" placeholder="index.html (ievadi relatīvu ceļu jūsu vietnē, piem., index.html)" />
        <button id="load">Ielādēt</button>
        <div class="seg" role="group" aria-label="Ekrāna izmērs">
          <button data-sz="1366x768">1366×768</button>
          <button data-sz="1920x1080" aria-pressed="true">1920×1080</button>
          <button data-sz="414x896">414×896</button>
        </div>
        <button id="reload">Pārlādēt</button>
        <button id="toggleLog">Konsoles logs</button>
      </div>
      <div class="help">⚠️ Glabā šo failu <b>tajā pašā domēnā</b> kā testējamā lapa un ielādē ar <b>relatīvu ceļu</b> (piem., <code>index.html</code>).</div>
      <div class="note">Slēdži, lai atkārtotu Chrome 60 uzvedību (UA, moduļi, API, polyfilli):</div>
      <div class="bar" style="border-top:1px solid var(--border)">
        <label class="chk"><input id="disableVV" type="checkbox" checked> Atspējot <code>visualViewport</code></label>
        <label class="chk"><input id="useROPoly" type="checkbox" checked> <code>ResizeObserver</code> polyfill</label>
        <label class="chk"><input id="useIOPoly" type="checkbox"> <code>IntersectionObserver</code> polyfill</label>
        <label class="chk"><input id="flexGapFix" type="checkbox" checked> Fallback <code>flex-gap</code> → margin</label>
        <label class="chk"><input id="spoofUA" type="checkbox"> UA ≈ Chrome 60</label>
        <label class="chk"><input id="forceTouch" type="checkbox"> Simulēt skārienu (maxTouchPoints=10)</label>
        <label class="chk"><input id="forceDPR1" type="checkbox"> DevicePixelRatio=1</label>
        <label class="chk"><input id="blockModule" type="checkbox" checked> Bloķēt <code>&lt;script type="module"&gt;</code></label>
        <label class="chk"><input id="pruneModern" type="checkbox" checked> Nogriezt modernās API</label>
      </div>
      <div class="warnline">Ja ievadīsi URL citā domēnā, injekcija netiks pielikta (drošības dēļ). Testē ar relatīvu ceļu.</div>
    </header>

    <section class="main">
      <div id="device" class="device" style="width:1920px;height:1080px">
        <div class="badge" id="dims">1920×1080 @ DPR?</div>
        <!-- NO allow-same-origin → nav brīdinājuma -->
        <iframe id="frame" class="frame" sandbox="allow-scripts allow-forms allow-pointer-lock allow-popups allow-modals"></iframe>
      </div>
      <aside id="log" class="log" aria-live="polite">
        <h4>Iframe konsoles žurnāls</h4>
        <div id="logc"></div>
      </aside>
    </section>
  </div>

<script>
(function(){
  const url = document.getElementById('url');
  const frame = document.getElementById('frame');
  const device = document.getElementById('device');
  const dims = document.getElementById('dims');
  const btnLoad = document.getElementById('load');
  const btnReload = document.getElementById('reload');
  const btnLog = document.getElementById('toggleLog');
  const log = document.getElementById('log');
  const logc = document.getElementById('logc');
  const chk = id => document.getElementById(id);

  // izmēri
  document.querySelectorAll('.seg [data-sz]').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.seg [data-sz]').forEach(x=>x.setAttribute('aria-pressed','false'));
      b.setAttribute('aria-pressed','true');
      const [w,h]=b.dataset.sz.split('x').map(Number);
      device.style.width = w+'px';
      device.style.height = h+'px';
      dims.textContent = `${w}×${h} @ DPR?`;
    });
  });

  btnLog.addEventListener('click', ()=>{ log.style.display = (log.style.display==='block')?'none':'block'; });
  btnReload.addEventListener('click', ()=>{ if (frame.contentWindow) frame.contentWindow.location.reload(); });
  btnLoad.addEventListener('click', ()=> loadTarget(url.value.trim() || 'index.html'));
  url.addEventListener('keydown', e=>{ if(e.key==='Enter') loadTarget(url.value.trim()||'index.html'); });

  // saņem ziņas no child
  window.addEventListener('message', (e)=>{
    const d = e.data;
    if(!d || d.__em_sig!=='chrome60') return;
    const pre = document.createElement('pre');
    pre.className = d.level || 'log';
    pre.textContent = `[${(d.level||'log').toUpperCase()}] ` + (d.text||'');
    logc.appendChild(pre);
    log.style.display = 'block';
    log.scrollTop = log.scrollHeight;
    if(d.type==='meta' && d.dpr){ dims.textContent = `${device.style.width.replace('px','')}×${device.style.height.replace('px','')} @ DPR${d.dpr}`; }
  });

  function errorToLog(msg){
    const pre = document.createElement('pre');
    pre.className = 'err';
    pre.textContent = `[ERR] ${msg}`;
    logc.appendChild(pre);
    log.style.display = 'block';
    log.scrollTop = log.scrollHeight;
  }

  function sameOriginAbsolute(u){
    try{
      const full = new URL(u, location.href);
      return full.origin === location.origin ? full : null;
    }catch{ return null; }
  }

  // bloķēt <script type=module> ar drošu regex
  function blockModules(html){
    // 1) <script type="module">
    html = html.replace(/<script\b([^>]*)>/gi, function(all, attrs){
      if(/\btype\s*=\s*["']module["']/i.test(attrs)){
        const newAttrs = attrs.replace(/\btype\s*=\s*["']module["']/i,'').trim();
        return '<script type="text/plain" data-blocked="module" '+ newAttrs + '>';
      }
      return all;
    });
    // 2) <link rel="modulepreload">
    html = html.replace(/<link\b([^>]*\brel\s*=\s*["']modulepreload["'][^>]*)>/gi, '<!-- modulepreload blocked -->');
    return html;
  }

  async function loadTarget(path){
    logc.textContent = '';
    const abs = sameOriginAbsolute(path);
    if(!abs){ errorToLog('URL ir citā domēnā vai nederīgs – lieto relatīvu ceļu (piem., index.html).'); return; }

    let html;
    try{
      const res = await fetch(abs.href, {cache:'no-store', credentials:'same-origin'});
      if(!res.ok) throw new Error(res.status+' '+res.statusText);
      html = await res.text();
    }catch(e){
      errorToLog('Neizdevās ielādēt mērķi: '+e.message);
      return;
    }

    const opts = {
      disableVV: chk('disableVV').checked,
      useROPoly: chk('useROPoly').checked,
      useIOPoly: chk('useIOPoly').checked,
      flexGapFix: chk('flexGapFix').checked,
      spoofUA: chk('spoofUA').checked,
      forceTouch: chk('forceTouch').checked,
      forceDPR1: chk('forceDPR1').checked,
      blockModule: chk('blockModule').checked,
      pruneModern: chk('pruneModern').checked
    };

    if(opts.blockModule){ html = blockModules(html); }

    // PRELUDE – inline <script> iekš mērķa <head> agrāk par visu citu
    const prelude =
      '<base href="'+abs.href.replace(/"/g,'&quot;')+'">'+
      '<script>(function(){'+
      'var OPTS='+JSON.stringify(opts)+';'+
      'function post(l,t,x){try{parent.postMessage({__em_sig:"chrome60",level:l,text:t,type:(x&&x.type)||"",dpr:(x&&x.dpr)||null},"*");}catch(e){}}'+
      '(function hook(){try{var o={};["log","warn","error"].forEach(function(k){o[k]=console[k];console[k]=function(){try{post(k,Array.prototype.map.call(arguments,function(a){try{return typeof a==="object"?JSON.stringify(a):String(a);}catch(e){return String(a);}}).join(" "));}catch(e){};return o[k].apply(this,arguments);};});window.addEventListener("error",function(e){post("err",(e.message||"")+" @"+(e.filename||"")+":"+ (e.lineno||""));},{passive:true});window.addEventListener("unhandledrejection",function(e){post("err","Unhandled promise rejection: "+(e.reason&&e.reason.message?e.reason.message:String(e.reason)));},{passive:true});post("ok","Emulācijas prelude ielādēts.",{type:"meta",dpr:window.devicePixelRatio||"?"});}catch(e){}})();'+

      // UA spoof
      '(function(){if(!OPTS.spoofUA) return;try{var ua60="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.113 Safari/537.36";var P=Object.getPrototypeOf(navigator);if(P){Object.defineProperty(P,"userAgent",{configurable:true,get:function(){return ua60;}});}if("userAgentData" in navigator){try{Object.defineProperty(P,"userAgentData",{configurable:true,get:function(){return undefined;}});}catch(e){}}post("log","UA spoof → Chrome 60");}catch(e){post("warn","UA spoof neizdevās: "+e.message);}})();'+

      // Touch & DPR
      '(function(){try{if(OPTS.forceTouch){var P=Object.getPrototypeOf(navigator);if(P){Object.defineProperty(P,"maxTouchPoints",{configurable:true,get:function(){return 10;}});}try{Object.defineProperty(window,"ontouchstart",{configurable:true,value:null});}catch(e){} post("log","Touch režīms ieslēgts");} if(OPTS.forceDPR1){try{Object.defineProperty(window,"devicePixelRatio",{configurable:true,get:function(){return 1;}});post("log","DPR=1");}catch(e){post("warn","DPR piesaiste neizdevās: "+e.message);}}}catch(e){}})();'+

      // visualViewport
      '(function(){try{if(OPTS.disableVV){try{Object.defineProperty(window,"visualViewport",{configurable:true,value:undefined});post("log","visualViewport atspējots");}catch(e){}}else if(!("visualViewport" in window)){var vv=(function(){var o={};var w=innerWidth,h=innerHeight,s=1,x=0,y=0;var evt=document.createDocumentFragment();o.addEventListener=evt.addEventListener.bind(evt);o.removeEventListener=evt.removeEventListener.bind(evt);function upd(){var nw=innerWidth,nh=innerHeight;if(nw!==w||nh!==h){w=nw;h=nh;evt.dispatchEvent(new Event("resize"));}}Object.defineProperties(o,{width:{get:function(){return w;}},height:{get:function(){return h;}},scale:{get:function(){return s;}},pageTop:{get:function(){return y;}},pageLeft:{get:function(){return x;}}});addEventListener("resize",upd,{passive:true});addEventListener("scroll",function(){var ny=pageYOffset||document.documentElement.scrollTop;if(ny!==y){y=ny;evt.dispatchEvent(new Event("scroll"));}},{passive:true});return o;})();Object.defineProperty(window,"visualViewport",{configurable:true,value:vv});post("log","visualViewport polyfill ieslēgts");}}catch(e){}})();'+

      // ResizeObserver
      '(function(){try{if(OPTS.useROPoly){if(typeof window.ResizeObserver==="undefined"){function RO(cb){this.cb=cb;this.items=[];}RO.prototype.observe=function(el){if(!this.items.find(function(i){return i.el===el;})){this.items.push({el:el,box:el.getBoundingClientRect()});}};RO.prototype.unobserve=function(el){this.items=this.items.filter(function(i){return i.el!==el;});};RO.prototype.disconnect=function(){this.items.length=0;};var Obs=new Set();function tick(inst){var entries=[];inst.items.forEach(function(it){var r=it.el.getBoundingClientRect();if(Math.abs(r.width-it.box.width)>0.5||Math.abs(r.height-it.box.height)>0.5){entries.push({target:it.el,contentRect:r});it.box=r;}});if(entries.length)try{inst.cb(entries,inst);}catch(e){console.error(e);}}setInterval(function(){Obs.forEach(tick);},250);var C=function(cb){var ro=new RO(cb);Obs.add(ro);return ro;};C.toString=function(){return "function ResizeObserver() { [polyfill] }";};window.ResizeObserver=C;post("log","ResizeObserver polyfill ieslēgts");}else{post("log","ResizeObserver atbalstīts");}}else{try{Object.defineProperty(window,"ResizeObserver",{configurable:true,value:undefined});post("warn","ResizeObserver atspējots");}catch(e){}}}catch(e){}})();'+

      // IntersectionObserver
      '(function(){try{if(OPTS.useIOPoly && typeof window.IntersectionObserver==="undefined"){function IO(cb,opts){this.cb=cb;this.items=[];this.thresholds=[(opts&&opts.threshold)||0];}IO.prototype.observe=function(el){if(!this.items.find(function(i){return i.el===el;})){this.items.push({el:el,vis:false});}};IO.prototype.unobserve=function(el){this.items=this.items.filter(function(i){return i.el!==el;});};IO.prototype.disconnect=function(){this.items.length=0;};function vis(el){var r=el.getBoundingClientRect();return r.bottom>0&&r.right>0&&r.top<(innerHeight||document.documentElement.clientHeight)&&r.left<(innerWidth||document.documentElement.clientWidth);}var arr=[];function pump(){arr.forEach(function(io){var entries=[];io.items.forEach(function(it){var v=vis(it.el);if(v!==it.vis){it.vis=v;entries.push({target:it.el,isIntersecting:v,intersectionRatio:v?1:0});}});if(entries.length)try{io.cb(entries,io);}catch(e){console.error(e);}});}setInterval(pump,200);addEventListener("scroll",pump,{passive:true});addEventListener("resize",pump,{passive:true});window.IntersectionObserver=function(cb,opts){var io=new IO(cb,opts);arr.push(io);return io;};post("log","IntersectionObserver polyfill ieslēgts");}}catch(e){}})();'+

      // flex-gap fallback
      '(function(){if(!OPTS.flexGapFix) return;function px(n){return Number(String(n).replace("px",""))||0}function apply(root){var all=root.querySelectorAll("*");for(var i=0;i<all.length;i++){var el=all[i];var cs=getComputedStyle(el);if(cs.display!=="flex") continue;var rg=px(cs.rowGap),cg=px(cs.columnGap);if((rg||cg)&&!el.__gapFixed){el.__gapFixed=true;el.style.rowGap="0px";el.style.columnGap="0px";var isRow=cs.flexDirection.indexOf("row")===0;var kids=Array.prototype.slice.call(el.children);kids.forEach(function(ch,idx){var s=ch.style,gcs=getComputedStyle(ch);if(isRow){if(idx) s.marginLeft=(px(gcs.marginLeft)+cg)+"px";if(rg){s.marginTop=px(gcs.marginTop)+"px";s.marginBottom=px(gcs.marginBottom)+"px";}}else{if(idx) s.marginTop=(px(gcs.marginTop)+rg)+"px";if(cg){s.marginLeft=px(gcs.marginLeft)+"px";s.marginRight=px(gcs.marginRight)+"px";}}});}}}var mo=new MutationObserver(function(){apply(document.body);});mo.observe(document.documentElement,{childList:true,subtree:true});addEventListener("DOMContentLoaded",function(){apply(document.body);});setTimeout(function(){apply(document.body);},0);post("log","flex-gap → margin fallback ieslēgts");})();'+

      // Prune modern APIs
      '(function(){if(!OPTS.pruneModern) return;try{try{delete String.prototype.replaceAll;}catch(e){try{String.prototype.replaceAll=undefined;}catch(e2){}}try{window.AbortController=undefined;}catch(e){}try{window.AbortSignal=undefined;}catch(e){}try{window.structuredClone=undefined;}catch(e){}try{window.crypto && (window.crypto.randomUUID=undefined);}catch(e){}try{if(window.CSS && window.CSS.supports){var orig=window.CSS.supports;window.CSS.supports=function(prop,val){if(arguments.length===2 && (prop==="gap"||prop==="row-gap"||prop==="column-gap")) return false;return orig.apply(this,arguments);};}}catch(e){}post("warn","Modernās API nogrieztas (replaceAll, AbortController, structuredClone, randomUUID, CSS.gap)");}catch(e){}})();'+

      // Info
      'post("ok","Chrome60 emulācijas komplekts injicēts.");'+
      '})();' + '<' + '/script>';

    // Ievietojam prelude tieši aiz <head>
    let finalHTML;
    const headIdx = html.search(/<head[^>]*>/i);
    if(headIdx !== -1){
      const insertPos = html.indexOf('>', headIdx) + 1;
      finalHTML = html.slice(0, insertPos) + '\n' + prelude + '\n' + html.slice(insertPos);
    } else {
      finalHTML = prelude + '\n' + html;
    }

    // Rakstām child dokumentā ar SRC-DOC (nav vajadzīgs allow-same-origin)
    frame.srcdoc = finalHTML;
  }

  // noklusētais ceļš
  url.value = 'index.html';
})();
</script>
</body>
</html>
