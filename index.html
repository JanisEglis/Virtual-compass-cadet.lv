<!DOCTYPE html>
<html lang="lv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CADET.LV • Interaktīvais kompass © Jānis Eglis</title>
<link rel="icon" type="image/png" href="https://site-710050.mozfiles.com/files/710050/CADET_ICON.PNG" />
<style>
  :root{
    --brand:#437e12;          /* Tava zīmola zaļā */
    --accent:#d0021b;         /* Brīdinājumiem */
    --bg:#0f0f10;
    --panel:rgba(0,0,0,.72);
    --panel-soft:rgba(255,255,255,.06);
    --text:#fff;
    --muted:#bfc3c7;
    --vh:1vh;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    background:#0b0b0b;
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
    overflow:hidden;
  }

  /* App bar */
  .appbar{
    position:fixed; inset:0 0 auto 0; height:52px; z-index:40;
    display:flex; align-items:center; justify-content:space-between;
    padding:0 12px;
    background:linear-gradient(180deg, rgba(0,0,0,.85), rgba(0,0,0,.45));
    backdrop-filter:saturate(120%) blur(6px);
    border-bottom:1px solid var(--panel-soft);
  }
  .appbar-title{
    font-weight:700; letter-spacing:.3px; display:flex; align-items:center; gap:10px
  }
  .appbar-title img{ width:22px; height:22px; display:block }
  .appbar-actions{ display:flex; gap:8px }

  .icon-btn{
    width:36px; height:36px; border:0; cursor:pointer; border-radius:10px;
    background:var(--panel); color:var(--text);
    display:grid; place-items:center; transition:box-shadow .15s, transform .06s;
  }
  .icon-btn:hover{ box-shadow:0 0 0 2px rgba(255,255,255,.08) inset }
  .icon-btn:active{ transform:scale(.98) }
  .icon-btn:focus-visible{ outline:2px solid var(--brand) }

  /* Status bar */
  .statusbar{
    position:fixed; inset:auto 0 0 0; height:36px; z-index:35;
    background:linear-gradient(0deg, rgba(0,0,0,.8), rgba(0,0,0,.35));
    border-top:1px solid var(--panel-soft);
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; padding:0 12px; font-size:13px; color:#e8e8e8;
  }
  .statusbar small{ color:var(--muted) }

  /* Darba laukums */
  #stage{
    position:fixed; inset:52px 0 36px 0;   /* starp appbar un statusbar */
    background:#181818;
  }

  /* Kanva + “tukšā stāvokļa” uzraksts */
  #canvasContainer{
    position:absolute; inset:0;
  }
  #mapCanvas{
    display:block; width:100%; height:100%;
    background:#111;
    background-image:url('https://site-710050.mozfiles.com/files/710050/medium/CADET_TRANSP_.png?1542126381');
    background-repeat:no-repeat;
    background-size:70% 30%;
    background-position:center;
    image-rendering:crisp-edges;
    touch-action:none;      /* ļaujam saviem gesture apstrādātājiem */
  }
  #emptyState{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    color:#c9c9c9; font-size:18px; pointer-events:none; text-align:center; padding:12px;
  }

  /* Pogu paliktnis (dock) */
  #buttonContainer{
    position:absolute; inset:auto 0 14px 0; z-index:20;
    display:flex; gap:10px; justify-content:center; pointer-events:none;
    transition:all .2s ease;
  }
  #buttonContainer.left{
    inset:auto auto 50% 14px; transform:translateY(50%);
    flex-direction:column; justify-content:flex-end; align-items:flex-start;
  }
  #buttonContainer.right{
    inset:auto 14px 50% auto; transform:translateY(50%);
    flex-direction:column; justify-content:flex-end; align-items:flex-end;
  }
  .tool-btn{
    pointer-events:auto;
    width:64px; height:64px; border-radius:14px;
    border:1px solid var(--panel-soft);
    background:rgba(20,20,20,.8);
    display:grid; place-items:center; cursor:pointer;
    transition:box-shadow .15s, transform .06s;
  }
  .tool-btn:hover{ box-shadow:0 0 0 2px rgba(255,255,255,.08) inset }
  .tool-btn:active{ transform:scale(.98) }
  .tool-btn:focus-visible{ outline:2px solid var(--brand) }
  .tool-btn img{ width:80%; height:80%; object-fit:contain }

  /* Tikai skārienierīcēm parādām noteiktās pogas */
  .touch-only{ display:none }
  @media (pointer:coarse){
    .touch-only{ display:grid }
  }

  /* Pogu paliktņa novietojuma slēdzis */
  .dock-switch{
    position:absolute; right:12px; top:12px; z-index:26;
    background:var(--panel); padding:8px 10px; border-radius:12px;
    display:flex; gap:12px; align-items:center; border:1px solid var(--panel-soft);
  }
  .dock-switch label{ display:flex; gap:6px; align-items:center; font-size:13px }
  .dock-switch input{ accent-color:var(--brand) }

  /* Kompass (virs kanvas) */
  #compassContainer{
    position:absolute; width:25vw; height:14vw; z-index:21;
    left:550px; top:60px; transform-origin:center center; pointer-events:none;
    image-rendering:crisp-edges;
  }
  #compassScaleContainer{ position:relative; width:25vw; height:14vw; transform-origin:center center; pointer-events:none }
  #compassInner{
    position:absolute; width:14vw; height:14vw; left:41.5%; top:0%;
    transform:translate(-50%,-50%) rotate(0deg); transform-origin:center center; pointer-events:none;
  }
  #compassBase{
    position:absolute; width:25vw; height:auto; left:13.5%; top:50%;
    transform:translate(-49.9%,-50.2%); pointer-events:auto;
  }
  #compassScaleInner{
    position:absolute; width:14vw; height:14vw; left:41.5%; top:0%;
    transform:translate(-50%,-50%) rotate(70deg); transform-origin:center center; pointer-events:none;
  }
  #compassScale{
    position:absolute; width:13vw; height:13vw; left:50.05%; top:50.04%;
    transform:translate(-50%,-50%); border-radius:50%; pointer-events:auto;
  }
  #compassNeedle{
    position:absolute; width:.65vw; height:auto; left:69.5%; top:50%;
    transform:translate(-50%,-50%); transform-origin:center center; opacity:.85;
    animation:needle 50s linear infinite;
  }
  @keyframes needle{ from{ transform:translate(-50%,-50%) rotate(0deg) } to{ transform:translate(-50%,-50%) rotate(360deg) } }

  /* Kartes izmēra rokturis */
  #resizeHandle{
    position:absolute; width:40px; height:40px; border-radius:6px;
    background:rgba(255,0,0,.5);
    display:none; align-items:center; justify-content:center; cursor:se-resize; z-index:22;
  }
  #resizeHandle img{ width:90%; height:90%; object-fit:contain; pointer-events:none }

  /* Dialogi (help/QR) */
  dialog.sheet{
    border:0; border-radius:16px; padding:16px 18px; background:#111; color:#fff; max-width:560px
  }
  dialog.sheet::backdrop{ backdrop-filter:blur(3px); background:rgba(0,0,0,.5) }
  dialog.sheet h3{ margin:.2em 0 .4em 0 }
  kbd{ background:#1c1c1c; padding:2px 6px; border-radius:6px; border:1px solid #333 }

  /* Toastrs */
  #toast{
    position:fixed; right:14px; bottom:64px; z-index:9999; min-width:200px; max-width:380px;
    background:#111; color:#fff; border:1px solid #222; border-radius:12px; padding:10px 12px; display:none;
  }
  #toast.show{ display:block; animation:fade-in .16s ease-out }
  @keyframes fade-in{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }

  /* Orientācijas pārklājums */
  #orientationOverlay{
    position:fixed; inset:0; display:none; z-index:50; background:#000; color:#fff;
    align-items:center; justify-content:center; text-align:center; padding:20px;
  }
  #orientationOverlay img{ max-width:420px; width:80%; height:auto }

  /* Fullscreen padoms mazā ekrānā */
  #fullscreenMessage{
    position:fixed; inset:0; display:none; z-index:34; color:white;
    background:rgba(0,0,0,.4); backdrop-filter:blur(5px);
    align-items:center; justify-content:center; text-align:center; padding:16px;
  }
  #fullscreenMessagetext{
    background:rgba(255,0,0,.45); border:2px solid red; border-radius:12px;
    max-width:min(700px,90%); padding:18px; font-weight:700;
  }
  .highlight-title{ font-size:min(28px,2.6vw); display:block; margin-bottom:6px }

  /* Samazina pārmērīgas animācijas lietotājiem ar reduced motion */
  @media (prefers-reduced-motion: reduce){
    *{ animation-duration:.001ms !important; animation-iteration-count:1 !important; transition-duration:.001ms !important; scroll-behavior:auto !important }
  }
</style>
</head>
<body>

  <!-- Galvene -->
  <header class="appbar" role="banner" aria-label="Lietotnes galvene">
    <div class="appbar-title">
      <img src="https://site-710050.mozfiles.com/files/710050/CADET_ICON.PNG" alt="CADET.LV">
      CADET.LV • Interaktīvais kompass
    </div>
    <nav class="appbar-actions" aria-label="Lietotnes darbības">
      <button class="icon-btn" id="btnHelp" aria-label="Palīdzība" title="Palīdzība (H)">❓</button>
      <button class="icon-btn" id="btnFullscreen" aria-label="Pilnekrāns" title="Pilnekrāns (F)">⛶</button>
      <button class="icon-btn" id="btnShare" aria-label="Koplietošana / QR" title="Koplietošana / QR (Q)">◱</button>
    </nav>
  </header>

  <!-- Darba laukums -->
  <main id="stage" role="main" aria-label="Darba laukums">
    <!-- Pogu paliktnis novietojuma izvēlei -->
    <div class="dock-switch" role="group" aria-label="Pogu novietojums">
      <label><input type="radio" name="dock" value="bottom" checked> Apakšā</label>
      <label><input type="radio" name="dock" value="left"> Kreisā</label>
      <label><input type="radio" name="dock" value="right"> Labā</label>
    </div>

    <!-- Kanva -->
    <div id="canvasContainer" aria-label="Karte">
      <canvas id="mapCanvas" width="1920" height="1080"></canvas>
      <div id="emptyState">Ievelc kartes attēlu šeit vai spied “Augšupielādēt karti”.</div>
      <div id="resizeHandle" aria-hidden="true">
        <img src="https://site-710050.mozfiles.com/files/710050/resize_map__1_.png" alt="">
      </div>
      <input type="file" accept="image/*" id="fileInput" style="display:none" />
    </div>

    <!-- Pogu paliktnis -->
    <div class="bottom" id="buttonContainer">
      <button id="resetMap" class="tool-btn" title="Atiestatīt karti (R)" aria-label="Atiestatīt karti">
        <img src="https://site-710050.mozfiles.com/files/710050/RESER_MAPS_Cropped-Photoroom.png" alt="">
      </button>
      <button id="uploadMap" class="tool-btn" title="Augšupielādēt karti" aria-label="Augšupielādēt karti">
        <img src="https://site-710050.mozfiles.com/files/710050/UPLOAD_MAPS_Cropped-Photoroom.png" alt="">
      </button>
      <button id="resetCompass" class="tool-btn" title="Atiestatīt kompasu (C)" aria-label="Atiestatīt kompasu">
        <img src="https://site-710050.mozfiles.com/files/710050/RESET_COMPASS_Cropped-Photoroom.png" alt="">
      </button>

      <button class="tool-btn touch-only" id="toggleRotationMode" title="Pārslēgt rotācijas režīmu (skārienam)" aria-label="Pārslēgt rotācijas režīmu">
        <img src="https://site-710050.mozfiles.com/files/710050/ROTATE_COMPASS_BASE__1__Cropped-Photoroom.png" alt="">
      </button>
      <button class="tool-btn touch-only" id="lockRotationMode" title="Bloķēt rotāciju (skārienam)" aria-label="Bloķēt rotāciju">
        <img src="https://site-710050.mozfiles.com/files/710050/COMPASS_ROTATE_LOCK_OPEN__1__Cropped-Photoroom.png" alt="">
      </button>

      <button id="gridView" class="tool-btn" title="Noteikšanas režīma izvēle" aria-label="Noteikšanas režīms">
        <img src="https://site-710050.mozfiles.com/files/710050/GRID_VIEW_Cropped-Photoroom.png" alt="">
      </button>

      <button id="toggleFullscreen" class="tool-btn" title="Pilnekrāns (F)" aria-label="Pilnekrāna pārslēgšana">
        <img id="fullscreenIcon" src="https://site-710050.mozfiles.com/files/710050/fulscreen.png" alt="">
      </button>
    </div>

    <!-- Kompass -->
    <div id="compassContainer" aria-label="Kompass">
      <div id="compassScaleContainer">
        <div id="compassInner">
          <img id="compassBase" src="https://site-710050.mozfiles.com/files/710050/VIRTUALAIS_KOMPASS_PAMATNE_PV6.png" alt="Kompass pamatne">
        </div>
        <div id="compassScaleInner">
          <img id="compassScale" src="https://site-710050.mozfiles.com/files/710050/KOMPASA_SKALA_CADET_LV_PV6_V3.png" alt="Kompass skala">
        </div>
        <img id="compassNeedle" src="https://site-710050.mozfiles.com/files/710050/VIRTUALAIS_KOMPASS_ADATA_CADET_LV_PV4.png" alt="Kompass adata">
      </div>
    </div>

  </main>

  <!-- Statusa josla -->
  <footer class="statusbar" aria-live="polite">
    <span id="statusLeft">Gatavs.</span>
    <span id="statusRight"><small>Pelīte: velc karti • Ritenis: tuv./tāl. • Shift/Alt/Ctrl + ritenis: kompass</small></span>
  </footer>

  <!-- Dialogi -->
  <dialog id="helpDialog" class="sheet">
    <h3>Ātrā palīdzība</h3>
    <ul>
      <li><kbd>F</kbd> – Pilnekrāns</li>
      <li><kbd>R</kbd> – Atjaunot karti</li>
      <li><kbd>C</kbd> – Atjaunot kompasu</li>
      <li><kbd>Shift</kbd>/<kbd>Alt</kbd>/<kbd>Ctrl</kbd> + ritenis – kompass</li>
      <li>Skāriens: vilkšana/pinch/rotācija (ja nav bloķēta)</li>
    </ul>
    <p><a href="https://cadet.mozello.lv/virtualais-kompass-macibu-materiali-un-instrukcija/lietotaja-celvedis/page/" target="_blank" rel="noopener">Pilnā instrukcija</a></p>
    <button id="helpClose" class="icon-btn" style="width:auto;padding:6px 10px;border-radius:8px">Aizvērt</button>
  </dialog>

  <dialog id="shareDialog" class="sheet">
    <h3>Koplietošana</h3>
    <p>Parādi auditorijai QR kodu, lai ātri atvērtu šo rīku.</p>
    <div style="display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap">
      <img id="qrImg" src="https://site-710050.mozfiles.com/files/710050/DOC_ERROR_AR_KRUSTU_PNG-1.png" alt="QR kods" style="width:220px;height:220px;border-radius:8px" />
      <div>
        <label for="shareUrl" style="display:block;margin-bottom:6px">Saite:</label>
        <input id="shareUrl" type="text" style="width:260px;padding:6px 8px;border-radius:8px;border:1px solid #333;background:#0c0c0c;color:#eee" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="copyLink" class="icon-btn" style="width:auto;padding:6px 10px;border-radius:8px">Kopēt</button>
          <button id="shareClose" class="icon-btn" style="width:auto;padding:6px 10px;border-radius:8px">Aizvērt</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Toastrs -->
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- Pilnekrāna uzvedne (mazos logos) -->
  <div id="fullscreenMessage">
    <p id="fullscreenMessagetext">
      <span class="highlight-title">Lūdzu, iestatiet logu pilnā izmērā, lai sāktu darbu.</span>
      Varat izmantot F11, lai logu darbinātu pilnekrāna režīmā, vai palielināt logu līdz ekrāna izmēram.<br><br>
      <a href="https://cadet.lv" target="_blank" style="color:#fff;font-weight:700">CADET.LV</a><br>
      <span class="copyright">CADET.LV | © Jānis Eglis</span>
    </p>
  </div>

  <!-- Orientācijas pārklājums mobilajām ierīcēm -->
  <div id="orientationOverlay" aria-hidden="true">
    <div>
      <h2>Lūdzu, pagriez ierīci horizontāli</h2>
      <img src="https://site-710050.mozfiles.com/files/710050/medium/Rotate_V5-2.jpg" alt="Pagrieziet ierīci">
    </div>
  </div>

<script>
(() => {
  /* ======= Palīgfunkcijas ======= */
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const toastEl = $('#toast');
  const mapCanvas = $('#mapCanvas');
  const ctx = mapCanvas.getContext('2d');
  const emptyState = $('#emptyState');
  const resizeHandle = $('#resizeHandle');
  const fileInput = $('#fileInput');
  const buttonContainer = $('#buttonContainer');
  const fullscreenIcon = $('#fullscreenIcon');

  const statusLeft = $('#statusLeft');
  function setStatus(msg, timeout=2500){
    statusLeft.textContent = msg;
    if(timeout){ setTimeout(()=> statusLeft.textContent='Gatavs.', timeout); }
  }
  function toast(msg){ toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=> toastEl.classList.remove('show'), 2400); }
  function updateVH(){ document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01) + 'px'); }
  updateVH(); window.addEventListener('resize', updateVH);

  /* ======= Pilnekrāns ======= */
  const btnFullscreen = $('#btnFullscreen');
  const toggleFullscreenBtn = $('#toggleFullscreen');
  function isFullscreen(){
    return document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement || document.mozFullScreenElement;
  }
  function enterFullscreen(){
    const el = document.documentElement;
    (el.requestFullscreen?.bind(el) || el.webkitRequestFullscreen?.bind(el) || el.msRequestFullscreen?.bind(el) || el.mozRequestFullScreen?.bind(el) || (()=>Promise.resolve()))()
      ?.().catch(()=>{});
  }
  function exitFullscreen(){
    (document.exitFullscreen?.bind(document) || document.webkitExitFullscreen?.bind(document) || document.msExitFullscreen?.bind(document) || document.mozCancelFullScreen?.bind(document) || (()=>Promise.resolve()))()
      ?.().catch(()=>{});
  }
  function setFullscreenIcon(){
    fullscreenIcon.src = isFullscreen()
      ? 'https://site-710050.mozfiles.com/files/710050/fulscreen_exit.png'
      : 'https://site-710050.mozfiles.com/files/710050/fulscreen.png';
  }
  function toggleFullscreen(){
    if(!isFullscreen()){ enterFullscreen(); } else { exitFullscreen(); }
  }
  toggleFullscreenBtn.addEventListener('click', toggleFullscreen);
  btnFullscreen.addEventListener('click', toggleFullscreen);
  ['fullscreenchange','webkitfullscreenchange','mozfullscreenchange','MSFullscreenChange','visibilitychange']
    .forEach(ev => document.addEventListener(ev, ()=>{ setFullscreenIcon(); toast(isFullscreen()?'Pilnekrāns ieslēgts':'Pilnekrāns izslēgts'); }));

  /* ======= Help & Share dialogi ======= */
  const helpDialog = $('#helpDialog');
  $('#btnHelp').addEventListener('click', ()=> helpDialog.showModal());
  $('#helpClose').addEventListener('click', ()=> helpDialog.close());

  const shareDialog = $('#shareDialog');
  const shareUrl = $('#shareUrl');
  const qrImg = $('#qrImg');
  $('#btnShare').addEventListener('click', ()=>{
    const url = location.href;
    shareUrl.value = url;
    // Ja tev ir reāls QR ģenerators – šeit aizvieto ar īsto QR attēlu.
    qrImg.src = 'https://site-710050.mozfiles.com/files/710050/DOC_ERROR_AR_KRUSTU_PNG-1.png';
    shareDialog.showModal();
  });
  $('#shareClose').addEventListener('click', ()=> shareDialog.close());
  $('#copyLink').addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(shareUrl.value); toast('Saite iekopēta.'); }catch{ toast('Neizdevās kopēt.'); }
  });

  /* ======= Pilnekrāna uzvedne maziem logiem + orientācija ======= */
  const fullscreenMessage = $('#fullscreenMessage');
  function checkWindowSize(){
    const w = window.innerWidth, h = window.innerHeight;
    fullscreenMessage.style.display = (w >= 1024 && h >= 700) ? 'none' : 'flex';
  }
  checkWindowSize();
  window.addEventListener('resize', checkWindowSize);

  const orientationOverlay = $('#orientationOverlay');
  function checkOrientation(){
    if (window.matchMedia("(orientation: portrait)").matches && window.innerWidth < 1024) {
      orientationOverlay.style.display = 'flex';
    } else {
      orientationOverlay.style.display = 'none';
    }
  }
  checkOrientation();
  window.addEventListener('resize', checkOrientation);
  window.addEventListener('orientationchange', checkOrientation);

  /* ======= Pogu paliktnis: dock switch ======= */
  const dockRadios = $$('input[name="dock"]');
  const savedDock = localStorage.getItem('buttonPosition');
  if(savedDock){
    buttonContainer.classList.remove('bottom','left','right');
    buttonContainer.classList.add(savedDock);
    dockRadios.forEach(r=> r.checked = (r.value===savedDock));
  }
  dockRadios.forEach(r=>{
    r.addEventListener('change', ()=>{
      buttonContainer.classList.remove('bottom','left','right');
      buttonContainer.classList.add(r.value);
      localStorage.setItem('buttonPosition', r.value);
      setStatus(`Pogu paliktnis: ${r.labels[0].innerText}`);
    });
  });

  /* ======= KARTES ATTĒLS: ielāde, vilkšana, tālummaiņa, izmērs ======= */
  const img = new Image();   // pašreiz ielādētā karte
  let imgX = 0, imgY = 0;    // attēla kreisā-augšējā stūra koordinātas uz kanvas
  let imgW = 0, imgH = 0;    // attēla renderētie izmēri uz kanvas
  let imgScale = 1;          // papildu mērogs
  let dragging = false;      // velkšana ar peli
  let startX = 0, startY = 0;
  let lastTouchDistance = 0; // pinch
  let resizing = false;      // izmēra mainīšana ar rokturi
  let startW = 0, startH = 0, startClientX = 0, startClientY = 0;

  function draw(){
    ctx.clearRect(0,0,mapCanvas.width,mapCanvas.height);
    if(imgW>0 && imgH>0){
      ctx.drawImage(img, imgX, imgY, imgW*imgScale, imgH*imgScale);
      // sarkanā apmale ap karti
      ctx.lineWidth = 2; ctx.strokeStyle='red';
      ctx.strokeRect(imgX, imgY, imgW*imgScale, imgH*imgScale);
      positionResizeHandle();
    }
  }
  function fitToCanvas(){
    if(!img.naturalWidth || !img.naturalHeight) return;
    const aspect = img.naturalWidth / img.naturalHeight;
    const scaleFactor = .85;
    if(mapCanvas.width / mapCanvas.height > aspect){
      imgW = mapCanvas.height * aspect * scaleFactor;
      imgH = mapCanvas.height * scaleFactor;
    } else {
      imgW = mapCanvas.width * scaleFactor;
      imgH = (mapCanvas.width / aspect) * scaleFactor;
    }
    imgX = (mapCanvas.width - imgW)/2;
    imgY = (mapCanvas.height - imgH)/2;
    imgScale = 1;
  }
  function positionResizeHandle(){
    if(!(imgW>0 && imgH>0)){ resizeHandle.style.display='none'; return; }
    resizeHandle.style.display = 'flex';
    const off = (window.innerWidth<=768) ? 5 : 0;
    resizeHandle.style.left = (imgX + imgW*imgScale - resizeHandle.clientWidth - off) + 'px';
    resizeHandle.style.top  = (imgY + imgH*imgScale - resizeHandle.clientHeight - off) + 'px';
  }
  function hideEmpty(){ emptyState.style.display='none'; }

  // ielāde caur dialogu
  $('#uploadMap').addEventListener('click', ()=> fileInput.click());
  fileInput.addEventListener('change', (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    const rd = new FileReader();
    rd.onload = ev => { img.src = ev.target.result; };
    rd.readAsDataURL(f);
  });

  // Drag & drop atbalsts
  mapCanvas.addEventListener('dragover', e=> e.preventDefault());
  mapCanvas.addEventListener('drop', e=>{
    e.preventDefault();
    const f = e.dataTransfer.files?.[0];
    if(!f) return;
    const rd = new FileReader();
    rd.onload = ev => { img.src = ev.target.result; };
    rd.readAsDataURL(f);
  });

  img.onload = () => { hideEmpty(); fitToCanvas(); draw(); setStatus('Karte ielādēta.'); };

  // Reset karti
  $('#resetMap').addEventListener('click', ()=>{ fitToCanvas(); draw(); setStatus('Karte atiestatīta.'); });

  // Peles vilkšana
  mapCanvas.addEventListener('mousedown', (e)=>{
    // ja tur rokturi – resize, nevis map drag
    const rhRect = resizeHandle.getBoundingClientRect();
    if(e.clientX>=rhRect.left && e.clientX<=rhRect.right && e.clientY>=rhRect.top && e.clientY<=rhRect.bottom){
      // sāksim resize
      resizing = true;
      startW = imgW; startH = imgH; startClientX = e.clientX; startClientY = e.clientY;
      return;
    }
    startX = e.offsetX; startY = e.offsetY; dragging = true;
  });
  window.addEventListener('mousemove', (e)=>{
    if(resizing){
      const dx = e.clientX - startClientX;
      const dy = e.clientY - startClientY;
      imgW = Math.max(50, startW + dx);
      imgH = Math.max(50, startH + dy);
      draw(); return;
    }
    if(!dragging) return;
    const dx = e.offsetX - startX, dy = e.offsetY - startY;
    imgX += dx; imgY += dy;
    startX = e.offsetX; startY = e.offsetY;
    draw();
  });
  window.addEventListener('mouseup', ()=>{ dragging=false; resizing=false; });

  // Ritenis = zoom (ap peles punktu)
  mapCanvas.addEventListener('wheel', (e)=>{
    e.preventDefault();
    if(!(imgW>0 && imgH>0)) return;
    const zoom = e.deltaY > 0 ? 0.95 : 1.05;
    const rect = mapCanvas.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    const ox = mx - imgX, oy = my - imgY;
    imgX = mx - ox * zoom;
    imgY = my - oy * zoom;
    imgScale *= zoom;
    draw();
  }, { passive:false });

  // Touch: drag + pinch zoom
  mapCanvas.addEventListener('touchstart', (e)=>{
    e.preventDefault();
    if(e.touches.length===1){
      const t=e.touches[0], rect = mapCanvas.getBoundingClientRect();
      startX = t.clientX - rect.left; startY = t.clientY - rect.top; dragging = true;
    } else if(e.touches.length===2){
      lastTouchDistance = dist(e.touches[0], e.touches[1]);
    }
  }, { passive:false });
  mapCanvas.addEventListener('touchmove', (e)=>{
    e.preventDefault();
    const rect = mapCanvas.getBoundingClientRect();
    if(e.touches.length===1 && dragging){
      const t=e.touches[0], x=t.clientX-rect.left, y=t.clientY-rect.top;
      const dx=x-startX, dy=y-startY; imgX+=dx; imgY+=dy; startX=x; startY=y; draw();
    } else if(e.touches.length===2){
      const d = dist(e.touches[0], e.touches[1]);
      const zoom = d / (lastTouchDistance || d);
      lastTouchDistance = d;

      // palielinām ap centru starp pieskārieniem
      const cx = (e.touches[0].clientX + e.touches[1].clientX)/2 - rect.left;
      const cy = (e.touches[0].clientY + e.touches[1].clientY)/2 - rect.top;
      const ox = cx - imgX, oy = cy - imgY;
      imgX = cx - ox * zoom; imgY = cy - oy * zoom;
      imgScale *= zoom; draw();
    }
  }, { passive:false });
  mapCanvas.addEventListener('touchend', ()=>{ dragging=false; });

  function dist(a,b){ const dx=a.clientX-b.clientX, dy=a.clientY-b.clientY; return Math.hypot(dx,dy); }

  /* ======= KOMPASS: pārvietošana, mērogs, bāzes/skalas rotācija ======= */
  const compassContainer = $('#compassContainer');
  const compassScaleContainer = $('#compassScaleContainer');
  const compassInner = $('#compassInner');
  const compassScaleInner = $('#compassScaleInner');
  const lockRotationModeButton = $('#lockRotationMode');
  const toggleRotationModeButton = $('#toggleRotationMode');

  // Sākotnējās vērtības
  let compassLeft = 550, compassTop = 60;
  let globalScale = 1;
  let baseRotation = 0;
  let scaleRotation = 70;
  let activeRotationTarget = 'compassInner'; // 'compassInner' vai 'compassScaleInner'
  let isRotationLocked = false;

  function updateCompass(){
    compassContainer.style.left = compassLeft + 'px';
    compassContainer.style.top  = compassTop  + 'px';
    compassScaleContainer.style.transform = `scale(${globalScale})`;
    compassInner.style.transform = `rotate(${baseRotation}deg)`;
    compassScaleInner.style.transform = `rotate(${scaleRotation}deg)`;
  }
  updateCompass();

  // Peles vilkšana kompasam
  let compDrag = false, compDX=0, compDY=0;
  compassContainer.addEventListener('mousedown',(e)=>{
    e.preventDefault();
    compDrag = true;
    const rect = compassContainer.getBoundingClientRect();
    compDX = e.clientX - rect.left;
    compDY = e.clientY - rect.top;
  });
  window.addEventListener('mousemove',(e)=>{
    if(!compDrag) return;
    compassLeft = e.clientX - compDX;
    compassTop  = e.clientY - compDY;
    updateCompass();
  });
  window.addEventListener('mouseup', ()=> compDrag=false);

  // Skāriens: drag + pinch scale + rotācija
  let lastTouchDist = 0, lastRotAngle = 0;
  compassContainer.addEventListener('touchstart',(e)=>{
    e.preventDefault();
    if(e.touches.length===1){
      const r = compassContainer.getBoundingClientRect();
      compDX = e.touches[0].clientX - r.left;
      compDY = e.touches[0].clientY - r.top;
    }else if(e.touches.length===2){
      lastTouchDist = dist(e.touches[0], e.touches[1]);
      lastRotAngle = angle(e.touches[0], e.touches[1]);
    }
  }, { passive:false });
  compassContainer.addEventListener('touchmove',(e)=>{
    e.preventDefault();
    if(e.touches.length===1){
      compassLeft = e.touches[0].clientX - compDX;
      compassTop  = e.touches[0].clientY - compDY;
      updateCompass();
    } else if(e.touches.length===2){
      const d = dist(e.touches[0], e.touches[1]);
      globalScale *= d / (lastTouchDist || d);
      lastTouchDist = d;
      if(!isRotationLocked){
        const ang = angle(e.touches[0], e.touches[1]);
        if(activeRotationTarget==='compassInner'){ baseRotation += ang - lastRotAngle; }
        else { scaleRotation += ang - lastRotAngle; }
        lastRotAngle = ang;
      }
      updateCompass();
    }
  }, { passive:false });
  function angle(t1,t2){
    const dx=t2.clientX-t1.clientX, dy=t2.clientY-t1.clientY;
    return Math.atan2(dy,dx)*180/Math.PI;
  }

  // Ritenis virs kompasa: rotācijas/mērogs ar modifikatoriem
  compassContainer.addEventListener('wheel', (e)=>{
    e.preventDefault();
    if(e.shiftKey){ baseRotation += e.deltaY * 0.005; }
    else if(e.altKey){ globalScale += e.deltaY * -0.0005; globalScale = Math.min(Math.max(0.5,globalScale),5); }
    else if(e.ctrlKey){ scaleRotation += e.deltaY * 0.005; }
    updateCompass();
  }, { passive:false });

  // Taustiņi (lēciens pa 5°)
  document.addEventListener('keydown', (e)=>{
    if(e.key==='ArrowLeft'){ baseRotation -= 5; updateCompass(); }
    else if(e.key==='ArrowRight'){ baseRotation += 5; updateCompass(); }
    else if(e.key==='ArrowUp'){ scaleRotation += 5; updateCompass(); }
    else if(e.key==='ArrowDown'){ scaleRotation -= 5; updateCompass(); }
  });

  // Reset kompasu
  $('#resetCompass').addEventListener('click', ()=>{
    compassLeft = 550; compassTop = 60; globalScale = 1; baseRotation = 0; scaleRotation = 70;
    updateCompass(); setStatus('Kompass atiestatīts.');
  });

  // Skārienierīcēm: pārslēgt rotācijas mērķi un bloķēt rotāciju
  toggleRotationModeButton?.addEventListener('click', ()=>{
    activeRotationTarget = (activeRotationTarget==='compassInner') ? 'compassScaleInner' : 'compassInner';
    toggleRotationModeButton.style.background = (activeRotationTarget==='compassInner') ? 'rgba(20,20,20,.8)' : 'rgb(187, 1, 1)';
  });
  lockRotationModeButton?.addEventListener('click', ()=>{
    isRotationLocked = !isRotationLocked;
    lockRotationModeButton.classList.toggle('active', isRotationLocked);
    setStatus(isRotationLocked?'Rotācija bloķēta.':'Rotācija atbloķēta.');
  });

  /* ======= “Grid view / režīmu izvēle” – divas ikonas popup ======= */
  const gridBtn = $('#gridView');
  gridBtn.addEventListener('click', ()=>{
    // Neliels izvēlnes dialogs ar divām opcijām
    const d = document.createElement('dialog');
    d.className='sheet';
    d.innerHTML = `
      <h3>Izvēlies noteikšanas metodi</h3>
      <div style="display:flex;gap:18px;justify-content:center">
        <button id="opt1" class="tool-btn" title="Režīms 1"><img src="https://site-710050.mozfiles.com/files/710050/GRID_VIEW_1_1.png" alt=""></button>
        <button id="opt2" class="tool-btn" title="Režīms 2"><img src="https://site-710050.mozfiles.com/files/710050/GRID_VIEW_2.png" alt=""></button>
      </div>
      <div style="display:flex;justify-content:center;margin-top:10px">
        <button id="closeGrid" class="icon-btn" style="width:auto;padding:6px 10px;border-radius:8px">Aizvērt</button>
      </div>
    `;
    document.body.appendChild(d);
    d.showModal();
    d.querySelector('#opt1').addEventListener('click', ()=>{ toast('Režīms 1 aktivizēts.'); d.close(); d.remove(); });
    d.querySelector('#opt2').addEventListener('click', ()=>{ toast('Režīms 2 aktivizēts.'); d.close(); d.remove(); });
    d.querySelector('#closeGrid').addEventListener('click', ()=>{ d.close(); d.remove(); });
  });

  /* ======= Īsinājumtaustiņi ======= */
  document.addEventListener('keydown', (e)=>{
    const k = e.key.toLowerCase();
    if(k==='f'){ toggleFullscreen(); }
    if(k==='r'){ $('#resetMap').click(); }
    if(k==='c'){ $('#resetCompass').click(); }
    if(k==='q'){ $('#btnShare').click(); }
    if(k==='h'){ helpDialog.open ? helpDialog.close() : helpDialog.showModal(); }
  });

  /* ======= Sākotnējais stāvoklis ======= */
  setFullscreenIcon();
  positionResizeHandle();
})();
</script>
</body>
</html>
