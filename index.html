<!doctype html>
<html lang="lv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>CADET.LV Interaktīvais kompass © Jānis Eglis</title>

  <!-- Trešo pušu CSS vispirms -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <!-- Tavs CSS pēc tam, lai var pārrakstīt -->
  <link rel="stylesheet" href="style.css">

  <!-- (pēc vajadzības) vieta JS ģenerētiem stiliem -->
  <style id="runtime-styles"></style>

  <!-- Leaflet JS pirms tava koda -->
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- TAVS kods – bez type="module" -->
  <script defer src="app.js"></script>
</head>
<body>


<!-- PRELOADER (sākuma pārklājums) -->
<div id="app-preloader" role="status" aria-live="polite" aria-label="Ielādējam…">
  <div class="preloader-inner">
    <img class="brand" src="https://site-710050.mozfiles.com/files/710050/medium/CADET_TRANSP_.png?1542126381" alt="CADET.LV" />
	<div class="preloader-about" aria-label="Par projektu">
  	<span>CADET.LV</span>
 	<span>INTERAKTĪVAIS KOMPASS</span>
  	<span>© JĀNIS EGLIS</span>
	</div>
	<div class="spinner" aria-hidden="true"></div>
    <div class="progress"><span style="width:0%"></span></div>
    <p class="msg">Ielādējam… 0%</p>
    <button id="preloaderSkip" class="skip" type="button">Turpināt</button>
  </div>
</div>


	
   	<!-- Brīdinājuma pārklājums viedtālruņiem -->
							<div id="mobile-warning" style="display: none;">
								<div class="warning-content">
									<p>Lūdzu, izmantojiet lielāku ekrānu šīs lietotnes darbībai.</p>
									<img style="width:100px; height:auto;" src="https://site-710050.mozfiles.com/files/710050/fullscreen-11-xxl.png" alt="Nepietiekams ekrāna izmērs" style="width: 80%; margin-top: 20px;">
									<p>INTERAKTĪVAIS KOMPASS</p>
									<p style="color: rgba(255, 255, 255, 0.5);">CADET.LV | © Jānis Eglis</p>
								</div>
							</div>

							<!-- Pārklājums mobilajām ierīcēm vertikālā režīmā -->
							<div id="orientation-overlay">
								<h1><img src="https://site-710050.mozfiles.com/files/710050/medium/Rotate_V5-2.jpg" alt="Pagrieziet ierīci"></h1>
							</div>						

							<div id="fullscreenMessage" class="fs-message-hidden">
								<div class="arrow"></div>
								<p id="fullscreenMessagetext">
									<span class="highlight-title">Lūdzu, iestatiet logu pilnā izmērā, lai sāktu darbu.</span>
									<br>
									Varat izmantot F11, lai logu darbinātu pilnekrāna režīmā vai palielināt logu līdz ekrāna izmēram spiežot simbolu "𖧵" pārlūka galvenē.<br><br>
									<a href="https://cadet.lv" target="_blank" style="color: white; font-weight: bold;">CADET.LV</a>
									<br>
									<span style="color: " class="copyright">CADET.LV | © Jānis Eglis</span>
								</p>
							</div> 
							
							<div id="touchscreenPopup"></div>
							
							<div id="fullscreenPopup"></div>

													
							<div id="canvasContainer" 
								 style="position: fixed; 
										width: 1920px; 
										height: 1080px;">

							 


<div id="canvasContainer" style="position:fixed;width:1920px;height:1080px;">
  <!-- 1) Vienīgā kanva (lokālajai bildes kartei) -->
  <canvas id="mapCanvas" width="1920" height="1080" style="display:block;width:100%;height:100%;"></canvas>

  <!-- 2) Tiešsaistes karte + tumšošanas pārklājums -->
  <div id="onlineMap">
    <div id="onlineMapDim"></div> <!-- tumšošanas pārklājums, pirmais bērns -->
    <!-- te Leaflet iemetīs karti -->
  </div>
</div>
                



								
							  <!-- Jaunais <img>, kur glabāt augšupielādēto attēlu -->
							  <img id="uploadedImg" 
								   src="" 
								   alt="Augšupielādētais attēls"
								   style="
									 position: absolute;
									 top: 0;
									 left: 0;
									 display: none; /* Slēpts līdz augšupielādē attēlu */
									 cursor: move;  /* Ja vēlaties, var padarīt arī pārvietojamu */
									  
									 ">
									 

							  <!-- MapResize rokturis -->
								<div id="resizeHandle">
									<img src="https://site-710050.mozfiles.com/files/710050/resize_map__1_.png" alt="Resize">
								</div>
							</div>

																			
							<!-- MapResize Papildu elements attēlam -->
							<img id="newUploadedImg" 
								 style="
								   position: absolute; 
								   top: 50px; 
								   left: 50px; 
								   display: none;
								   cursor: move;
								   
								 " 
								 alt="Augšupielādētais attēls">

							<!-- MapResize rokturis -->
							<div id="newResizeHandle"
								 style="
								   display: none;
								   width: 30px;
								   height: 30px;
								   position: absolute;
								   cursor: se-resize;
								   z-index: 9;
								 ">
							</div>						
							

							<div class="dropdown-container">
							        <div class="top-bar">
							            <span class="dropdown-toggle" id="toggleInstruction">Lietotāja ceļvedis ⬇</span>
							            <span class="dropdown-toggle" id="toggleMaterials">Mācību materiāli ⬇</span>
							        </div>
							
							        <div class="dropdown-menu" id="dropdownInstruction">
							            <a href="https://cadet.mozello.lv/virtualais-kompass-macibu-materiali-un-instrukcija/lietotaja-celvedis/page/">DARBAM AR DATORU</a>
							            <a href="https://cadet.mozello.lv/virtualais-kompass-macibu-materiali-un-instrukcija/lietotaja-celvedis/page-1/">DARBAM AR SKĀRIENJŪTĪGĀM IERĪCĒM</a>
										<a href="https://cadet.mozello.lv/virtualais-kompass-macibu-materiali-un-instrukcija/lietotaja-celvedis/page-2/">LIETOŠANAS NOTEIKUMI</a>
							           <iframe id="instructionFrame" name="contentFrame" style="width: 100%; height: 85vh; border: none;"></iframe>  
							            
							        </div>
							
							        <div class="dropdown-menu" id="dropdownMaterials">
							        <a href="https://cadet.mozello.lv/virtualais-kompass-macibu-materiali-un-instrukcija/macibu-materiali/topografiskas-kartes/" class="dropdown-link">TOPOGRĀFISKĀS KARTES</a>
							        <a href="https://cadet.mozello.lv/virtualais-kompass-macibu-materiali-un-instrukcija/macibu-materiali/merogs-un-attalumi/" class="dropdown-link">MĒROGS UN ATTĀLUMI</a>
							        <a href="https://cadet.mozello.lv/virtualais-kompass-macibu-materiali-un-instrukcija/macibu-materiali/apzimejumi-kartes/" class="dropdown-link">APZĪMĒJUMI KARTĒS</a>
							        <a href="https://cadet.mozello.lv/virtualais-kompass-macibu-materiali-un-instrukcija/macibu-materiali/direkcijas-lenkis-un-azimuts/" class="dropdown-link">DIREKCIJAS LEŅĶIS UN AZIMUTS</a>
							        <a href="https://cadet.mozello.lv/virtualais-kompass-macibu-materiali-un-instrukcija/macibu-materiali/koordinates/" class="dropdown-link">KOORDINĀTES</a>
							        <a href="https://cadet.mozello.lv/virtualais-kompass-macibu-materiali-un-instrukcija/macibu-materiali/citi/" class="dropdown-link">CITI</a>
									
									 
							 <iframe id="contentFrame" name="contentFrame" style="width: 100%; height: 75vh; border: none;"></iframe>
							        </div>
									 			
														
							</div>	
														

							 <!-- Izvēlne konteineram -->
							 <!-- Izvēlne konteineram LABAJĀ pusē -->
							<div class="position-selector-container">
								<div class="position-selector">
									<button class="toggle-selector">❯</button>
									<select id="positionSelect">
										<option disabled selected>Izvēlies pogas novietojumu:</option>
										<option value="bottom">Apakšā (noklusējums)</option>
										<option value="right">Labajā pusē</option>
										<option value="left">Kreisajā pusē</option>
									</select>
								</div>
							</div>

							<!-- Izvēlne konteineram KREISAJĀ pusē -->
							<div class="position-selector-container-left">
								<div class="position-selector-left">
									<button class="toggle-selector-left">❯</button>
									<select id="positionSelectLeft">
										<option disabled selected>Izvēlies pogas novietojumu:</option>
										<option value="bottom">Apakšā (noklusējums)</option>
										<option value="right">Labajā pusē</option>
										<option value="left">Kreisajā pusē</option>
									</select>
								</div>
							</div>

							<!-- Popup grid view -->
							<div id="popupMenu" style="display: none;">
								<h3>Izvēlieties noteikšanas metodi</h3>
								<div class="button-row">
									<button id="popupOption1" class="popup-button">
										<img src="https://site-710050.mozfiles.com/files/710050/GRID_VIEW_1_1.png" alt="Funkcija 1">
									</button>
									<button id="popupOption2" class="popup-button">
										<img src="https://site-710050.mozfiles.com/files/710050/GRID_VIEW_2.png" alt="Funkcija 2">
									</button>
								</div>
								<button id="popupClose" class="popup-close">Aizvērt</button>
							</div>

							<!-- Pogas konteiners -->
							<div class="button-container bottom" id="buttonContainer">
								<button id="resetMap">
									<img src="https://site-710050.mozfiles.com/files/710050/RESER_MAPS_Cropped-Photoroom.png" alt="Reset Map">
								</button>
								<button id="uploadMap">
									<img src="https://site-710050.mozfiles.com/files/710050/UPLOAD_MAPS_Cropped-Photoroom.png" alt="Upload Map">
								</button>
                <button id="toggleOnlineMap" data-title="Tiešsaistes karte" aria-label="Tiešsaistes karte">
                  <img alt="Tiešsaistes karte"
                       src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='3,6 9,3 15,6 21,3 21,18 15,21 9,18 3,21 3,6'/%3E%3Cline x1='9' y1='3' x2='9' y2='18'/%3E%3Cline x1='15' y1='6' x2='15' y2='21'/%3E%3C/svg%3E">
                </button>
								<button id="resetCompass">
									<img src="https://site-710050.mozfiles.com/files/710050/RESET_COMPASS_Cropped-Photoroom.png" alt="Reset Compass">
								</button>
								<button class="touch-only" id="toggleRotationMode">
									<img src="https://site-710050.mozfiles.com/files/710050/ROTATE_COMPASS_BASE__1__Cropped-Photoroom.png" alt="Toggle Rotation">
								</button>			
								<button class="touch-only" id="lockRotationMode">
									<img src="https://site-710050.mozfiles.com/files/710050/COMPASS_ROTATE_LOCK_OPEN__1__Cropped-Photoroom.png" alt="Lock Rotation">
								</button>	
								<button id="rotateCompass90">
									<img src="https://site-710050.mozfiles.com/files/710050/GRID_VIEW_Cropped-Photoroom.png" alt="Rotate 90° and Lock">
								</button>
								<button id="toggleFullscreen">
								<img id="fullscreenIcon" src="https://site-710050.mozfiles.com/files/710050/icon_fullscreen_enter.png" alt="Pilnkrāna Ieslēgšana">
								</button>
							</div>
							
							<div id="about">
							<a href="javascript:void(0);" class="qrLink" onclick="toggleIframeQR(event)">KOPLIETOT</a>
								<span class="abouttext">CADET.LV</span>
								<span class="abouttext" >INTERAKTĪVAIS KOMPASS</span> 
								<span class="abouttext">© JĀNIS EGLIS</span>
								<a href="javascript:void(0);" class="aboutlink" onclick="toggleIframeAbout(event)">ATSAUKSME / ZIŅOT</a>
							</div>
							
							
							<!-- IFRAME KONTEINERS (SĀKOTNĒJI PASLĒPTS) -->
							<div id="iframeContainerAbout">
								<iframe id="feedbackIframe" src="https://docs.google.com/forms/d/e/1FAIpQLSdflr72km2RpI7hdn05AmH5gRZgBk69y7UCz0sCJ37ujOyQ3Q/viewform?embedded=true" frameborder="0"></iframe>
								<button id="closeIframeAbout" onclick="toggleIframeAbout(event)">✖</button>
							</div>						
							
							<!-- QR kods konteineris (SĀKOTNĒJI PASLĒPTS) -->
							<div id="iframeContainerQR">
								<div id="qrCodeContent">
									<p class="qrTitle">KOPLIETOŠANAS QR KODS AUDITORIJAI</p>
									<img id="qrCodeImage" src="https://site-710050.mozfiles.com/files/710050/DOC_ERROR_AR_KRUSTU_PNG-1.png" alt="QR Code">
								</div>
								<button id="closeIframeQR" onclick="toggleIframeQR(event)">✖</button>
							</div>

							<div id="compassContainer">
								<div id="compassScaleContainer">
									<div id="compassInner">
										<img id="compassBase" src="https://site-710050.mozfiles.com/files/710050/VIRTUALAIS_KOMPASS_PAMATNE_PV6.png" alt="Compass Base">
									</div>  
									<div id="compassScaleInner">
										<img id="compassScale" src="https://site-710050.mozfiles.com/files/710050/KOMPASA_SKALA_CADET_LV_PV6_V3.png" alt="Compass Scale">
									</div>      
									<img id="compassNeedle" src="https://site-710050.mozfiles.com/files/710050/VIRTUALAIS_KOMPASS_ADATA_CADET_LV_PV4.png" alt="Compass Needle">  
								</div>
							</div>
















<script>
(function(){
  if (window.__DevToolInstalled) return; 
  window.__DevToolInstalled = true;

  /* ---------- stils ---------- */
  const css = `
#devtoolsBtn{
  position:fixed; bottom:12px; left:12px; z-index:2147483647;
  width:42px; height:42px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
  background:linear-gradient(180deg,#181c22,#12151a);
  color:#e9eef7; display:grid; place-items:center; cursor:pointer;
  box-shadow:0 10px 26px rgba(0,0,0,.45); font-size:20px; line-height:1;
}
#devtoolsBtn:hover{ transform:translateY(-1px); }
#devtoolsPanel{
  position:fixed; right:12px; bottom:12px; z-index:2147483647;
  width:min(480px,96vw); height:min(68vh,88vh);
  background:linear-gradient(180deg,#0e1116f2,#12151af2);
  border:1px solid rgba(255,255,255,.12); border-radius:14px;
  box-shadow:0 18px 40px rgba(0,0,0,.55); color:#e9eef7;
  font:13px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  display:flex; flex-direction:column; overflow:hidden;
}
#devtoolsPanel.closed{ display:none; }
#devtoolsPanel .hdr{display:flex;align-items:center;gap:10px;padding:10px 12px;background:linear-gradient(180deg,#141920,#0f1318);}
#devtoolsPanel .hdr strong{font-weight:700;}
#devtoolsPanel .hdr .pill{margin-left:auto;font-size:11px;padding:2px 8px;border-radius:999px;background:#1b2531;color:#c9d6e5;border:1px solid rgba(255,255,255,.08)}
#devtoolsPanel .hdr button{background:#232a33;border:1px solid rgba(255,255,255,.12);color:#e9eef7;border-radius:8px;height:30px;padding:0 8px;cursor:pointer}
#devtoolsPanel .body{padding:10px;display:flex;flex-direction:column;gap:8px;min-height:0}
#devtoolsPanel .row{display:flex;gap:8px;flex-wrap:wrap}
#devtoolsPanel .row .btn{background:#232a33;border:1px solid rgba(255,255,255,.12);color:#e9eef7;border-radius:8px;height:32px;padding:0 10px;cursor:pointer}
#devtoolsPanel .grid{display:grid;grid-template-columns: 1fr auto auto;gap:6px;align-items:center;border-top:1px solid rgba(255,255,255,.08);padding-top:8px}
#devtoolsPanel .grid .k{color:#9fb1c9}
#devtoolsPanel .ok{color:#8be28b} .warn{color:#ffd479} .bad{color:#ff6f6f}
#devtoolsPanel pre{flex:1;min-height:120px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);
  border-radius:10px;padding:8px 10px;overflow:auto;white-space:pre-wrap;word-break:break-word;}
`;

  const style = document.createElement('style'); style.textContent = css; document.head.appendChild(style);

  /* ---------- helpers ---------- */
  const $ = sel => document.querySelector(sel);
  const exists = sel => !!$(sel);
  const now = () => new Date().toISOString().replace('T',' ').replace('Z','');
  function safeRect(el){ try{ const r = el.getBoundingClientRect(); return {w:Math.round(r.width), h:Math.round(r.height)}; }catch(_){ return {w:0,h:0}; } }
  function isVisible(el){
    if (!el) return false;
    const cs = getComputedStyle(el);
    const r = el.getBoundingClientRect();
    return cs.display!=='none' && cs.visibility!=='hidden' && r.width>0 && r.height>0;
  }
  function textBool(b){ return b ? '✓' : '✕'; }

  /* ---------- UI ---------- */
  const btn = document.createElement('button');
  btn.id='devtoolsBtn'; btn.type='button'; btn.title='Atvērt diagnostiku'; btn.innerText='🛠️';
  document.body.appendChild(btn);

  const panel = document.createElement('div');
  panel.id='devtoolsPanel'; panel.className='closed';
  panel.innerHTML = `
    <div class="hdr">
      <strong>DevTool • Tāfeles diagnostika</strong>
      <span id="devStatus" class="pill">idle</span>
      <button id="devClose">Aizvērt</button>
    </div>
    <div class="body">
      <div class="row">
        <button id="devRun"   class="btn">Palaist Health-check</button>
        <button id="devTrace" class="btn">Sākt izsekošanu</button>
        <button id="devCopy"  class="btn">Kopēt atskaiti</button>
        <button id="devClear" class="btn">Tīrīt žurnālu</button>
      </div>
      <div id="devHealth" class="grid"></div>
      <pre id="devLog" aria-live="polite"></pre>
    </div>`;
  document.body.appendChild(panel);

  const statusEl = panel.querySelector('#devStatus');
  const logEl    = panel.querySelector('#devLog');
  let tracing = false;
  const cleanups = [];

  function setStatus(txt){ statusEl.textContent = txt; }
  function log(msg, obj){
    const line = `[${now()}] ${msg}` + (obj ? `\n${stringify(obj)}` : '');
    logEl.textContent += (logEl.textContent ? '\n' : '') + line;
    logEl.scrollTop = logEl.scrollHeight;
    try{ console.debug('%c[DevTool]','color:#8ab4f8', msg, obj||''); }catch(_){}
  }
  window.__devlog = log; // noder, ja gribi pašrocīgi ielogot no sava koda

  function stringify(v){
    try{ return (typeof v==='string') ? v : JSON.stringify(v, (k,val)=> val instanceof Node ? `[Node:${val.nodeName}]` : val, 2); }
    catch(_){ return String(v); }
  }

  function open(){ panel.classList.remove('closed'); setStatus('open'); }
  function close(){ panel.classList.add('closed'); setStatus('idle'); }
  btn.addEventListener('click', open);
  panel.querySelector('#devClose').addEventListener('click', close);

  /* ---------- Health-check ---------- */
  function kvRow(key, value, cls=''){
    const wrap = document.createDocumentFragment();
    const k = document.createElement('div'); k.className='k'; k.textContent = key;
    const v = document.createElement('div'); v.className=cls; v.textContent = value;
    const m = document.createElement('div'); m.textContent = ' ';
    wrap.appendChild(k); wrap.appendChild(v); wrap.appendChild(m);
    return wrap;
  }

  function runHealth(){
    setStatus('checking…');
    const grid = panel.querySelector('#devHealth');
    grid.textContent = '';

    // Pamatvide
    const vv = (window.visualViewport && Math.round(window.visualViewport.height)) || window.innerHeight;
    const w  = window.innerWidth, h = vv;
    const dpr = window.devicePixelRatio||1;
    const mtp = navigator.maxTouchPoints||0;
    grid.appendChild(kvRow('Logs', `${w}×${h} @${dpr}x`));
    grid.appendChild(kvRow('Touch', `${mtp} punkts/i`));

    // LocalStorage
    const onlineFlag = localStorage.getItem('onlineMapActive');
    const darken = localStorage.getItem('mapDarken')||'0';
    grid.appendChild(kvRow('onlineMapActive', String(onlineFlag)));
    grid.appendChild(kvRow('mapDarken', `${darken}%`));

    // Elementi
    const sels = [
      ['#mapCanvas','Canvas'],
      ['#onlineMap','Leaflet karte'],
      ['#onlineMapDim','Kartes pārklājums (dim)'],
      ['#buttonContainer','Pogu doks'],
      ['#mapDimmerRange','Tumšuma slīdnis'],
      ['#resizeHandle','Resize rokturis'],
      ['#compassContainer','Kompass'],
      ['#contentFrame','Saturs (Materials)'],
      ['#instructionFrame','Saturs (Guide)'],
      ['#fullscreenMessage','Fullscreen ziņa'],
      ['#mobile-warning','Mobile brīdinājums'],
      ['#touchscreenPopup','Touch popup'],
      ['#app-preloader','Preloader']
    ];
    sels.forEach(([sel,label])=>{
      const el = $(sel); const ok = !!el; 
      const visible = isVisible(el);
      const r = ok ? safeRect(el) : {w:0,h:0};
      grid.appendChild(kvRow(label, `${textBool(ok)}  ${visible?'(redzams)':'(n/redzams)'}  ${r.w}×${r.h}`, ok && visible ? 'ok' : (ok ? 'warn' : 'bad')));
    });

    // Leaflet
    const leafletLoaded = !!window.L;
    grid.appendChild(kvRow('Leaflet L', textBool(leafletLoaded), leafletLoaded?'ok':'bad'));
    let mapState = 'nav';
    try{
      const getMap = window.__getMap;
      if (typeof getMap === 'function') {
        const m = getMap();
        if (m && m._loaded) mapState = `ok (zoom ${m.getZoom()}, ctr ${m.getCenter().lat.toFixed(4)},${m.getCenter().lng.toFixed(4)})`;
        else if (m) mapState = 'inited (nav _loaded)';
      }
    }catch(_){}
    grid.appendChild(kvRow('Karte (ref)', mapState, /ok/.test(mapState)?'ok':(mapState==='nav'?'warn':'warn')));

    // Preloader stāvoklis
    const pre = $('#app-preloader');
    if (pre){
      const hidden = pre.classList.contains('hidden');
      const bodyPreloading = document.body.classList.contains('preloading');
      grid.appendChild(kvRow('Preloader', hidden?'pabeigts':'REDZAMS', hidden?'ok':'warn'));
      grid.appendChild(kvRow('Body.preloading', textBool(bodyPreloading), bodyPreloading?'warn':'ok'));
    }

    // “Tāfeles’” iesp. cēloņu hinti
    const hints = [];
    if (onlineFlag === '1' && !isVisible($('#onlineMap')) && !leafletLoaded) {
      hints.push('onlineMapActive=1, bet Leaflet nav ielādēts vai #onlineMap neredzams.');
    }
    if (!isVisible($('#mapCanvas'))) {
      hints.push('#mapCanvas neredzams — iespējams, pārklāts ar preloader vai tiešsaistes karti.');
    }
    if ($('#resizeHandle') && !isVisible($('#resizeHandle'))) {
      hints.push('Resize rokturis nav redzams — attēls var nebūt ielādēts.');
    }
    if (hints.length) grid.appendChild(kvRow('Hints', hints.join('  |  '), 'warn'));

    setStatus('ready');
    log('Health-check pabeigts', {hints});
  }

  /* ---------- Trace režīms ---------- */
  function on(el, ev, fn, opts){
    el.addEventListener(ev, fn, opts);
    cleanups.push(()=> el.removeEventListener(ev, fn, opts));
  }

  function startTrace(){
    if (tracing) return; tracing = true;
    setStatus('tracing');
    log('Izsekošana START');

    // log window kļūdas
    on(window, 'error', (e)=> log('window.error', {msg:e.message, src:e.filename, line:e.lineno}));
    on(window, 'unhandledrejection', (e)=> log('unhandledrejection', {reason: String(e.reason)}));

    // ielādes / preloaderis
    const pre = $('#app-preloader');
    if (pre){
      const mo = new MutationObserver(()=>{ 
        const hidden = pre.classList.contains('hidden');
        log('Preloader klase mainīta', {hidden});
      });
      mo.observe(pre, {attributes:true, attributeFilter:['class']});
      cleanups.push(()=> mo.disconnect());
    }

    // izmēri, orientācija, fullscreen
    ['resize','orientationchange','visibilitychange'].forEach(ev => on(window, ev, ()=> log(`window.${ev}`, {w:innerWidth,h:(visualViewport?visualViewport.height:innerHeight)})));
    on(document, 'fullscreenchange', ()=> log('fullscreenchange', {active: !!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement)}));

    // kartes notikumi, ja pieejami
    try{
      const getMap = window.__getMap;
      if (typeof getMap === 'function'){
        const m = getMap();
        if (m){
          ['load','moveend','zoomend','dragstart','contextmenu','popupopen'].forEach(ev=>{
            m.on(ev, (e)=> log(`Leaflet:${ev}`, {zoom:m.getZoom(), center:m.getCenter()}));
          });
          cleanups.push(()=> ['load','moveend','zoomend','dragstart','contextmenu','popupopen'].forEach(ev=> m.off(ev)));
          log('Leaflet trace piesaistīts');
        }
      }
    }catch(_){}

    // doks un pozīciju izvēlnes
    const bc = $('#buttonContainer');
    if (bc){
      const mo = new MutationObserver(()=> log('buttonContainer.class mainīts', {className: bc.className}));
      mo.observe(bc, {attributes:true, attributeFilter:['class']});
      cleanups.push(()=> mo.disconnect());
    }
  }

  function stopTrace(){
    if (!tracing) return; tracing = false;
    while(cleanups.length){ try{ cleanups.pop()(); }catch(_){ } }
    setStatus('ready'); log('Izsekošana STOP');
  }

  /* ---------- pogas ---------- */
  panel.querySelector('#devRun').addEventListener('click', runHealth);
  panel.querySelector('#devClear').addEventListener('click', ()=> (logEl.textContent=''));
  panel.querySelector('#devCopy').addEventListener('click', async ()=>{
    const healthTxt = panel.querySelector('#devHealth').innerText.replace(/\n{2,}/g,'\n');
    const full = `=== HEALTH ===\n${healthTxt}\n\n=== LOG ===\n${logEl.textContent}`;
    try{ await navigator.clipboard.writeText(full); setStatus('nokopēts'); }catch(_){ setStatus('copy fail'); }
  });
  panel.querySelector('#devTrace').addEventListener('click', (e)=>{
    if (!tracing){ startTrace(); e.target.textContent = 'Stop izsekošanu'; }
    else { stopTrace(); e.target.textContent = 'Sākt izsekošanu'; }
  });

  /* ---------- auto-hooki (ērtībai) ---------- */
  // log DOMContentLoaded / load
  if (document.readyState === 'complete') log('window.load (jau noticis)');
  else window.addEventListener('load', ()=> log('window.load'));

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ()=> log('DOMContentLoaded'));
  else log('DOMContentLoaded (jau noticis)');

  // preloader sākotnējais stāvoklis
  const pre = $('#app-preloader');
  if (pre) log('Preloader stāvoklis', {hidden: pre.classList.contains('hidden'), bodyPreloading: document.body.classList.contains('preloading')});

  // ja online karte bija ieslēgta — reģistrē hintu
  const onlineFlag = localStorage.getItem('onlineMapActive');
  if (onlineFlag === '1') log('onlineMapActive=1 — tiek gaidīts Leaflet', {leafletLoaded: !!window.L});

})();
</script>

















	
	
</body>
</html>
