<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CADET.LV InteraktÄ«vais kompass Â©JÄnis Eglis</title>

  <style>
    /* SÄkuma lapas poga (nemainÄ«ta) */
    #openInteractivebuttoncase{
      display:inline-flex;justify-content:center;align-items:center;width:100%;height:90%;
    }
    #openInteractive{
      display:flex;padding:10px 20px;background-color:#783200;color:#fff;border:none;border-radius:3px;
      font-size:16px;cursor:pointer;width:80%;justify-content:center;align-items:center;
    }
    #openInteractive:hover{ background:#bf5509; }
  </style>
</head>
<body>

  <p id="openInteractivebuttoncase">
    <button id="openInteractive">AtvÄ“rt InteraktÄ«vo kompasu</button>
  </p>

  <script>
  document.getElementById('openInteractive').addEventListener('click', () => {
    const interactiveWindow = window.open('', '_blank', 'width=1280,height=800');

    if (!interactiveWindow) {
      alert('PÄrlÅ«ks bloÄ·Ä“ jaunus logus. LÅ«dzu, atÄ¼aujiet pÄrlÅ«kam atvÄ“rt logus.');
      return;
    }

    interactiveWindow.document.write(`
<!DOCTYPE html>
<html lang="lv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="icon" type="image/png" href="https://site-710050.mozfiles.com/files/710050/CADET_ICON.PNG" />
<title>CADET.LV InteraktÄ«vais kompass Â©JÄnis Eglis</title>

<style>
  /* ========= TAVS ESOÅ AIS STILS (SAÄªSINÄ€TS TIKAI KOMENTÄ€RIEM) ========= */
  :root { --vh: 1vh; }
  html, body { height:100%; margin:0; padding:0; }
  body { height:calc(var(--vh) * 100); margin:0; padding:0; background:#f0f0f0;
         display:flex; align-items:center; justify-content:center; height:100vh; overflow:hidden; position:relative; }
  canvas{
    background-color:#181818;
    background-image:url('https://site-710050.mozfiles.com/files/710050/medium/CADET_TRANSP_.png?1542126381');
    background-repeat:no-repeat; background-attachment:fixed; background-size:70% 30%;
    background-position:center; z-index:1; height:100%; width:100%;
  }

  #fullscreenMessage{ position:fixed; z-index:15; color:white; background:rgba(0,0,0,.4);
    width:100%; height:100vh; display:flex; justify-content:center; align-items:center; visibility:visible;
    backdrop-filter:blur(5px); -webkit-backdrop-filter:blur(5px);
  }
  #fullscreenMessagetext{ background:rgba(255,0,0,.5); position:relative; color:white; font-weight:bold;
    padding:20px; width:60%; max-width:90%; text-align:center; border-radius:10px; border:2px solid red; z-index:50; box-sizing:border-box; }
  .highlight-title{ font-size:2.5vw; color:#fff; font-weight:bold; text-shadow:2px 2px 5px rgba(0,0,0,.5); display:block; margin-bottom:2px; }
  .copyright{ display:block; margin-top:10px; font-size:1.5vw; color:#fff; opacity:.8; }

  .arrow{ border-left:2.5vh solid transparent; border-right:2.5vh solid transparent; border-bottom:5vh solid red;
    position:fixed; top:20px; right:56px; display:flex; animation:bounce 1.5s infinite ease-in-out; z-index:10; }
  .arrow::before{ content:"ğ–§µ"; position:absolute; color:white; font-size:2.5vh; transform:scaleX(1.5); top:10px; right:-5px; z-index:11; }
  @keyframes bounce{ 0%{transform:translateY(0)} 50%{transform:translateY(-15px)} 100%{transform:translateY(0)} }

  #fullscreenMessage.hidden{ visibility:hidden; }
  .fs-message-hidden{ display:none !important; }

  @media (max-width:1024px){ :root{ --vh:1vh; } }

  /* â€”â€”â€” POZÄªCIJAS IZVÄ’LNES (nemainÄ«tas) â€”â€”â€” */
  .button-container.bottom{ /* vecais nosaukums â€” vairs neizmantojam vizuÄli, bet atstÄjam saderÄ«bai */ }
  .button-container.left{}
  .button-container.right{}

  .position-selector-container{ position:fixed; top:15%; right:0; transform:translateY(-50%); z-index:3; }
  .position-selector{ background:rgba(0,0,0,.8); padding:10px; border-radius:0; box-shadow:0 4px 6px rgba(0,0,0,.2);
    width:250px; display:flex; flex-direction:column; align-items:center; position:relative; transition:transform .3s ease-in-out; }
  .position-selector::after{ content:""; display:block; height:3px; background:rgba(255,0,0,.8); position:absolute; bottom:0; left:0; right:0; }
  .position-selector select{ width:200px; padding:5px; border:none; border-radius:3px; font-size:16px; background:rgba(0,0,0,.5); color:white; }
  .position-selector.hidden{ transform:translateX(100%); }
  .position-selector-container .toggle-selector{ position:absolute; top:50%; left:-11%; transform:translateY(-50%);
    background:rgba(255,0,51,.7); border:none; color:white; border-radius:10px 0 0 10px; width:30px; height:100%; cursor:pointer; }
  .position-selector-container .toggle-selector:hover{ background:rgba(255,0,0,.9); }

  .position-selector-container-left{ position:fixed; top:15%; left:0; transform:translateY(-50%); z-index:3; }
  .position-selector-left{ background:rgba(0,0,0,.8); padding:10px; border-radius:0; box-shadow:0 4px 6px rgba(0,0,0,.2);
    width:250px; display:flex; flex-direction:column; align-items:center; position:relative; transition:transform .3s ease-in-out; }
  .position-selector-left.hidden-left{ transform:translateX(-100%); }
  .toggle-selector-left{ position:absolute; top:50%; right:-7%; transform:translateY(-50%); background:rgba(255,0,51,.7);
    border:none; color:white; border-radius:0 10px 10px 0; width:30px; height:100%; cursor:pointer; }
  .toggle-selector-left:hover{ background:rgba(255,0,0,.9); }
  .position-selector-left select, .position-selector select{ width:230px; padding:5px; border:none; border-radius:3px; font-size:16px; background:rgba(0,0,0,.5); color:white; }
  .position-selector-left select option, .position-selector select option{ background:rgba(0,0,0,.6); color:white; border:2px solid red; border-radius:4px; }

  /* â€”â€”â€” DAUDZ PÄ€RÄ’JÄ€ TAVA STILA PALIEK NEMAINÄªTI (dropdowns, about, canvas, compass utt.) â€”â€”â€” */
  #compassContainer{ position:absolute; width:25vw; height:14vw; z-index:3; transform-origin:center; pointer-events:none; image-rendering:crisp-edges; }
  #compassScaleContainer{ position:relative; width:25vw; height:14vw; transform-origin:center; pointer-events:none; image-rendering:crisp-edges; }
  #compassInner{ position:absolute; width:14vw; height:14vw; left:41.5%; top:0%; transform:translate(-50%,-50%); transform-origin:center; image-rendering:crisp-edges; }
  #compassBase{ position:absolute; width:25vw; height:auto; left:13.5%; top:50%; transform:translate(-49.9%,-50.2%); transform-origin:center; display:block; pointer-events:auto; image-rendering:crisp-edges; }
  #compassScaleInner{ position:absolute; width:14vw; height:14vw; left:41.5%; top:0%; transform:translate(-50%,-50%) rotate(30deg); transform-origin:center; image-rendering:crisp-edges; }
  #compassScale{ position:absolute; width:13vw; height:13vw; left:50.05%; top:50.04%; transform:translate(-50%,-50%); transform-origin:center; display:block; pointer-events:auto; image-rendering:crisp-edges; border-radius:50%; }
  @keyframes rotateCompassNeedle{ from{transform:translate(-50%,-50%) rotate(0deg)} to{transform:translate(-50%,-50%) rotate(360deg)} }
  #compassNeedle{ position:absolute; width:.65vw; height:auto; left:69.5%; top:50%; transform:translate(-50%,-50%); transform-origin:center; opacity:.85; image-rendering:crisp-edges; animation:rotateCompassNeedle 50s linear infinite; }
  canvas,#compassContainer{ touch-action:none; }
  #mapCanvas.with-transition{ transition:transform .5s ease-in-out; }

  /* ======== JAUNAIS DOCK + KUPOLS (pogu konteiners) ======== */

  :root{
    --dock-bg:#0f1115;
    --dock1:#1b1f25; --dock2:#14171c;
    --dock-ring:#d22; --dock-icon:#eef2f7; --dock-muted:#3a3f47;
    --dock-shadow:0 12px 28px rgba(0,0,0,.45),0 2px 6px rgba(0,0,0,.35);

    /* Dinamika â€“ JS pÄrraksta uz .dock */
    --tipX: 50%;
    --labelW: 210px;       /* max platums etiÄ·etei */
    --capH: 32px;          /* kupola augstums (pielÄgojas etiÄ·etei) */
    --capSkew: 14px;       /* augÅ¡as saÅ¡aurinÄjums â€“ mazÄks = lÄ“zenÄki sÄni */
    --capR: 10px;          /* augÅ¡as stÅ«ru rÄdiuss (vienÄds ar etiÄ·eti) */
    --capExtraW: 12px;     /* papildu platums kupolam â€“ lÄ“zenÄki sÄni */
    --labelOffsetY: 2px;   /* etiÄ·etes vertikÄlÄ nobÄ«de */
  }

  /* Doka ÄrÄ“jais konteiners â€” saglabÄjam #buttonContainer + bottom|left|right */
  #buttonContainer.dock-wrap{
    position:fixed; width:100%; z-index:25; pointer-events:none; transition:all .20s ease-in-out;
  }
  #buttonContainer.bottom{ bottom: calc(var(--vh) * 5); left:50%; transform:translateX(-50%); display:flex; justify-content:center; }
  #buttonContainer.left{ bottom:50%; left:2%; transform:translateY(50%); display:flex; justify-content:flex-start; }
  #buttonContainer.right{ bottom:50%; right:2%; transform:translateY(50%); display:flex; justify-content:flex-end; }

  /* Pats doks */
  .dock{
    position:relative; overflow:visible; pointer-events:auto;
    display:flex; gap:22px; align-items:center;
    padding:14px 18px; border-radius:48px;
    background:linear-gradient(180deg,var(--dock1),var(--dock2));
    border:1px solid rgba(255,255,255,.04);
    box-shadow:var(--dock-shadow);
    backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);
  }

  /* Kupols (SVG) */
  .dock-cap{
    position:absolute; left:0;
    top:calc(-1 * var(--capH));
    width:calc(var(--labelW) + 22px + var(--capExtraW));
    height:var(--capH);
    transform:translateX(calc(var(--tipX) - 50%));
    transform-origin:bottom center;
    opacity:0; pointer-events:none; z-index:1;
    filter:drop-shadow(0 10px 18px rgba(0,0,0,.35));
    will-change:transform,opacity;
  }
  .dock.show-cap .dock-cap{
    opacity:1; animation:capPop .35s cubic-bezier(.17,.9,.25,1.2) both;
  }
  @keyframes capPop{
    0% { transform:translateX(calc(var(--tipX) - 50%)) scaleY(.2); }
    60%{ transform:translateX(calc(var(--tipX) - 50%)) scaleY(1.06); }
    100%{transform:translateX(calc(var(--tipX) - 50%)) scaleY(1); }
  }

  /* EtiÄ·ete (teksts) â€” sinhroni ar kupolu */
  .dock-label{
    position:absolute; left:0;
    top:calc(-1 * var(--capH) - var(--labelOffsetY));
    transform:translateX(calc(var(--tipX) - 50%));
    max-width:var(--labelW);
    padding:6px 12px;
    background:rgba(22,25,30,.92);
    border:1px solid rgba(210,34,34,.45);
    border-radius:var(--capR);
    color:#fff; font-size:13px; line-height:1.05; font-weight:600;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    box-shadow:0 8px 20px rgba(0,0,0,.35);
    backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);
    opacity:0; pointer-events:none; z-index:3;
    transition:opacity .18s ease, max-width .12s ease, clip-path .24s ease;
    clip-path: inset(0 50% 0 50% round var(--capR));
    will-change: transform, clip-path, opacity;
  }
  .dock.show-label .dock-label{
    opacity:1; clip-path: inset(0 0 0 0 round var(--capR));
    animation:labelIn .26s cubic-bezier(.22,.9,.24,1) both;
  }
  @keyframes labelIn{
    from{ transform:translateX(calc(var(--tipX) - 50%)) translateY(6px) scale(.96); }
    to  { transform:translateX(calc(var(--tipX) - 50%)) translateY(0)   scale(1); }
  }

  /* Doka pogas (override globÄlajam button stilam) */
  .dock-btn{
    all:unset; /* izolÄ“jamies no globÄlÄ button stila */
    --size:64px;
    width:var(--size); height:var(--size);
    position:relative; color:var(--dock-icon);
    border-radius:50%; display:grid; place-items:center; cursor:pointer;
    -webkit-tap-highlight-color:transparent; outline:none;
  }
  .dock-btn::before{
    content:""; position:absolute; inset:0; border-radius:50%;
    border:3px solid var(--dock-ring); box-shadow:0 6px 16px rgba(210,34,34,.35);
    transition:transform .18s ease, opacity .18s ease;
  }
  .dock-btn svg{ width:30px; height:30px }
  @media (hover:hover){ .dock-btn:hover::before{ transform:scale(1.07) } }
  .dock-btn:active::before{ transform:scale(.95); opacity:.9 }
  .dock-btn.muted::before{ border-color:var(--dock-muted); box-shadow:none }

  @media (max-width:540px){
    :root{ --labelW:180px; }
    .dock{ gap:16px; padding:12px 14px }
    .dock-btn{ --size:58px }
    .dock-btn svg{ width:26px; height:26px }
  }

  @media (prefers-reduced-motion: reduce){
    .dock-cap, .dock-label{ transition:none !important; animation:none !important; }
  }

</style>
</head>
<body>

  <!-- BrÄ«dinÄjumi / pÄrklÄjumi (nemainÄ«ti) -->
  <div id="fullscreenMessage" class="fs-message-hidden">
    <div class="arrow"></div>
    <p id="fullscreenMessagetext">
      <span class="highlight-title">LÅ«dzu, iestatiet logu pilnÄ izmÄ“rÄ, lai sÄktu darbu.</span><br />
      Varat izmantot F11 vai pÄrlÅ«ka pogu â€œğ–§µâ€.<br /><br />
      <a href="https://cadet.lv" target="_blank" style="color:#fff;font-weight:bold;">CADET.LV</a><br />
      <span class="copyright">CADET.LV | Â© JÄnis Eglis</span>
    </p>
  </div>

  <div id="touchscreenPopup"></div>
  <div id="fullscreenPopup"></div>

  <div id="canvasContainer" style="position:fixed;width:1920px;height:1080px;">
    <canvas id="mapCanvas" width="1920" height="1080" style="display:block;width:100%;height:100%;"></canvas>
    <img id="uploadedImg" src="" alt="AugÅ¡upielÄdÄ“tais attÄ“ls" style="position:absolute;top:0;left:0;display:none;cursor:move;">
    <div id="resizeHandle"><img src="https://site-710050.mozfiles.com/files/710050/resize_map__1_.png" alt="Resize"></div>
  </div>

  <img id="newUploadedImg" style="position:absolute; top:50px; left:50px; display:none; cursor:move;" alt="AugÅ¡upielÄdÄ“tais attÄ“ls">
  <div id="newResizeHandle" style="display:none; width:30px; height:30px; position:absolute; cursor:se-resize; z-index:9;"></div>

  <!-- Dropdown joslas (nemainÄ«tas) -->
  <div class="dropdown-container">
    <div class="top-bar">
      <span class="dropdown-toggle" id="toggleInstruction">LietotÄja ceÄ¼vedis â¬‡</span>
      <span class="dropdown-toggle" id="toggleMaterials">MÄcÄ«bu materiÄli â¬‡</span>
    </div>

    <div class="dropdown-menu" id="dropdownInstruction">
      <a href="https://cadet.mozello.lv/virtualais-kompass-macibu-materiali-un-instrukcija/lietotaja-celvedis/page/">DARBAM AR DATORU</a>
      <a href="https://cadet.mozello.lv/virtualais-kompass-macibu-materiali-un-instrukcija/lietotaja-celvedis/page-1/">DARBAM AR SKÄ€RIENJÅªTÄªGÄ€M IERÄªCÄ’M</a>
      <a href="https://cadet.mozello.lv/virtualais-kompass-macibu-materiali-un-instrukcija/lietotaja-celvedis/page-2/">LIETOÅ ANAS NOTEIKUMI</a>
      <iframe id="instructionFrame" name="contentFrame" style="width:100%; height:85vh; border:none;"></iframe>
    </div>

    <div class="dropdown-menu" id="dropdownMaterials">
      <a href="https://cadet.mozello.lv/virtualais-kompass-macibu-materiali-un-instrukcija/macibu-materiali/topografiskas-kartes/" class="dropdown-link">TOPOGRÄ€FISKÄ€S KARTES</a>
      <a href="https://cadet.mozello.lv/virtualais-kompass-macibu-materiali-un-instrukcija/macibu-materiali/merogs-un-attalumi/" class="dropdown-link">MÄ’ROGS UN ATTÄ€LUMI</a>
      <a href="https://cadet.mozello.lv/virtualais-kompass-macibu-materiali-un-instrukcija/macibu-materiali/apzimejumi-kartes/" class="dropdown-link">APZÄªMÄ’JUMI KARTÄ’S</a>
      <a href="https://cadet.mozello.lv/virtualais-kompass-macibu-materiali-un-instrukcija/macibu-materiali/direkcijas-lenkis-un-azimuts/" class="dropdown-link">DIREKCIJAS LEÅ…Ä¶IS UN AZIMUTS</a>
      <a href="https://cadet.mozello.lv/virtualais-kompass-macibu-materiali-un-instrukcija/macibu-materiali/koordinates/" class="dropdown-link">KOORDINÄ€TES</a>
      <a href="https://cadet.mozello.lv/virtualais-kompass-macibu-materiali-un-instrukcija/macibu-materiali/citi/" class="dropdown-link">CITI</a>
      <iframe id="contentFrame" name="contentFrame" style="width:100%; height:75vh; border:none;"></iframe>
    </div>
  </div>

  <!-- IzvÄ“lnes novietojumam (nemainÄ«tas) -->
  <div class="position-selector-container">
    <div class="position-selector">
      <button class="toggle-selector">â¯</button>
      <select id="positionSelect">
        <option disabled selected>IzvÄ“lies pogas novietojumu:</option>
        <option value="bottom">ApakÅ¡Ä (noklusÄ“jums)</option>
        <option value="right">LabajÄ pusÄ“</option>
        <option value="left">KreisajÄ pusÄ“</option>
      </select>
    </div>
  </div>

  <div class="position-selector-container-left">
    <div class="position-selector-left">
      <button class="toggle-selector-left">â¯</button>
      <select id="positionSelectLeft">
        <option disabled selected>IzvÄ“lies pogas novietojumu:</option>
        <option value="bottom">ApakÅ¡Ä (noklusÄ“jums)</option>
        <option value="right">LabajÄ pusÄ“</option>
        <option value="left">KreisajÄ pusÄ“</option>
      </select>
    </div>
  </div>

  <!-- Popup GRID menu (nemainÄ«ts) -->
  <div id="popupMenu" style="display:none;">
    <h3>IzvÄ“lieties noteikÅ¡anas metodi</h3>
    <div class="button-row">
      <button id="popupOption1" class="popup-button"><img src="https://site-710050.mozfiles.com/files/710050/GRID_VIEW_1_1.png" alt="Funkcija 1" /></button>
      <button id="popupOption2" class="popup-button"><img src="https://site-710050.mozfiles.com/files/710050/GRID_VIEW_2.png" alt="Funkcija 2" /></button>
    </div>
    <button id="popupClose" class="popup-close">AizvÄ“rt</button>
  </div>

  <!-- ====== LEGACY POGAS (SLÄ’PTAS) â€“ saglabÄ esoÅ¡os eventus ====== -->
  <div aria-hidden="true" style="display:none">
    <button id="resetMap"></button>
    <button id="uploadMap"></button>
    <button id="resetCompass"></button>
    <button id="rotateCompass90"></button>
    <button id="toggleFullscreen"><img id="fullscreenIcon" alt=""></button>
    <button id="toggleRotationMode"></button>
    <button id="lockRotationMode"></button>
  </div>

  <!-- ====== JAUNAIS DOCK POGU KONTEINERS ====== -->
  <div id="buttonContainer" class="dock-wrap bottom">
    <nav class="dock" id="dock" aria-label="GalvenÄ rÄ«kjosla">
      <svg class="dock-cap" id="dockCap" aria-hidden="true"></svg>
      <div class="dock-label" id="dockLabel"></div>

      <button class="dock-btn" data-title="RestartÄ“t karti" data-action="reset-map" aria-label="RestartÄ“t karti">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="1 4 1 10 7 10"></polyline><polyline points="23 20 23 14 17 14"></polyline>
          <path d="M20.49 9A9 9 0 0 0 6.47 6.47l-2.35 2"></path><path d="M3.51 15a9 9 0 0 0 14.02 2.53l2.35-2"></path>
        </svg>
      </button>

      <button class="dock-btn" data-title="RestartÄ“t kompasu" data-action="reset-compass" aria-label="RestartÄ“t kompasu">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle><polygon points="16 8 12 16 8 12 16 8"></polygon>
        </svg>
      </button>

      <button class="dock-btn" data-title="AugÅ¡upielÄdÄ“t karti" data-action="upload-map" aria-label="AugÅ¡upielÄdÄ“t karti">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
      </button>

      <button class="dock-btn" id="toggleBtn" data-title="Griezt skalu" data-action="toggle-rotate-target" aria-label="Griezt skalu">
        <svg id="toggleIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path>
        </svg>
      </button>

      <button class="dock-btn" data-title="BloÄ·Ä“t rotÄciju" data-action="lock-rotation" aria-label="BloÄ·Ä“t rotÄciju">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="11" width="18" height="10" rx="2"></rect>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
        </svg>
      </button>

      <button class="dock-btn" data-title="TÄ«klveida reÅ¾Ä«ms" data-action="grid-view" aria-label="TÄ«klveida reÅ¾Ä«ms">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect>
        </svg>
      </button>

      <button class="dock-btn" data-title="PilnekrÄna reÅ¾Ä«ms" data-action="fullscreen" aria-label="PilnekrÄna reÅ¾Ä«ms">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="4 14 4 20 10 20"></polyline><polyline points="20 10 20 4 14 4"></polyline>
          <line x1="14" y1="10" x2="20" y2="4"></line><line x1="4" y1="20" x2="10" y2="14"></line>
        </svg>
      </button>
    </nav>
  </div>

  <!-- About josla/QR/Feedback (nemainÄ«ts) -->
  <div id="about" style="position:fixed; bottom:0; width:100%; z-index:20; padding:.3vw; background:rgba(0,0,0,.8); color:rgba(255,255,255,.8); text-align:center;">
    <a href="javascript:void(0);" class="qrLink" onclick="toggleIframeQR(event)" style="display:inline-block;padding:5px 10px;background:#d0021b;color:#fff;font-weight:bold;text-decoration:none;border-radius:5px 5px 0 0;position:absolute;left:10px;bottom:-2px;z-index:5;width:170px;">KOPLIETOT</a>
    <span class="abouttext">CADET.LV</span>
    <span class="abouttext">INTERAKTÄªVAIS KOMPASS</span>
    <span class="abouttext">Â© JÄ€NIS EGLIS</span>
    <a href="javascript:void(0);" class="aboutlink" onclick="toggleIframeAbout(event)" style="display:inline-block;padding:5px 10px;background:#d0021b;color:#fff;font-weight:bold;text-decoration:none;border-radius:5px 5px 0 0;position:absolute;right:10px;top:0;z-index:5;width:170px;">ATSAUKSME / ZIÅ…OT</a>
  </div>

  <div id="iframeContainerAbout" style="position:fixed;width:500px;height:600px;bottom:-620px;right:20px;background:#fff;box-shadow:0 4px 6px rgba(0,0,0,.1);border-radius:8px;overflow:hidden;transition:bottom .5s ease-in-out;display:none;z-index:9999;">
    <iframe id="feedbackIframe" src="https://docs.google.com/forms/d/e/1FAIpQLSdflr72km2RpI7hdn05AmH5gRZgBk69y7UCz0sCJ37ujOyQ3Q/viewform?embedded=true" style="width:100%;height:100%;border:none;"></iframe>
    <button id="closeIframeAbout" onclick="toggleIframeAbout(event)" style="position:absolute;top:5px;right:5px;background:red;color:#fff;border:none;width:25px;height:25px;border-radius:50%;font-size:14px;cursor:pointer;">âœ–</button>
  </div>

  <div id="iframeContainerQR" style="position:fixed;width:300px;height:330px;bottom:-370px;left:20px;background:rgba(0,0,0,.8);box-shadow:0 4px 6px rgba(0,0,0,.1);border-radius:8px;overflow:hidden;transition:bottom .5s ease-in-out;display:none;z-index:20;text-align:center;padding:20px;">
    <div id="qrCodeContent">
      <p class="qrTitle" style="font-size:18px;font-weight:bold;margin-bottom:10px;color:#fff;">KOPLIETOÅ ANAS QR KODS AUDITORIJAI</p>
      <img id="qrCodeImage" src="https://site-710050.mozfiles.com/files/710050/DOC_ERROR_AR_KRUSTU_PNG-1.png" alt="QR Code" style="width:250px;height:250px;">
    </div>
    <button id="closeIframeQR" onclick="toggleIframeQR(event)" style="position:absolute;top:5px;right:5px;background:red;color:white;border:none;width:25px;height:25px;border-radius:50%;font-size:14px;cursor:pointer;">âœ–</button>
  </div>

  <!-- Kompass -->
  <div id="compassContainer">
    <div id="compassScaleContainer">
      <div id="compassInner">
        <img id="compassBase" src="https://site-710050.mozfiles.com/files/710050/VIRTUALAIS_KOMPASS_PAMATNE_PV6.png" alt="Compass Base">
      </div>
      <div id="compassScaleInner">
        <img id="compassScale" src="https://site-710050.mozfiles.com/files/710050/KOMPASA_SKALA_CADET_LV_PV6_V3.png" alt="Compass Scale">
      </div>
      <img id="compassNeedle" src="https://site-710050.mozfiles.com/files/710050/VIRTUALAIS_KOMPASS_ADATA_CADET_LV_PV4.png" alt="Compass Needle">
    </div>
  </div>

<script>
/* ========= TAVA ESOÅ Ä€ LOÄ¢IKA (saÄ«sinÄta komentÄriem) ========= */
function debounce(func, wait=50){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>func.apply(this,a), wait); }; }
function updateViewportHeight(){ const vh=window.innerHeight*0.01; document.documentElement.style.setProperty('--vh', vh+'px'); }
function checkWindowSize(){ const fm=document.getElementById('fullscreenMessage'); const w=window.innerWidth, h=window.innerHeight; if(w>=1024 && h>=700){ fm.classList.add('hidden'); } else { fm.classList.remove('hidden'); } }
function handleResize(){ updateViewportHeight(); checkWindowSize(); }
window.addEventListener('resize', debounce(handleResize,50)); window.addEventListener('orientationchange', handleResize); window.addEventListener('load', handleResize);

/* â€”â€”â€” KARTES ATTÄ’LS, ZÄªMÄ’Å ANA, UPLOAD, ZOOM, DRAG u.c. â€”â€”â€” */
const canvas=document.getElementById('mapCanvas'); const ctx=canvas.getContext('2d'); const img=new Image(); img.src='';
let imgX=0,imgY=0,imgScale=1,imgWidth,imgHeight,dragging=false,resizing=false,startX,startY,startWidth,startHeight,lastTouchDistance=0;
const resizeHandle=document.getElementById('resizeHandle');
resizeHandle.style.display='block'; resizeHandle.style.position='absolute'; resizeHandle.style.zIndex='10';
resizeHandle.style.width=Math.max(40, window.innerWidth*0.05)+'px'; resizeHandle.style.height=Math.max(40, window.innerHeight*0.05)+'px';
resizeHandle.style.cursor='se-resize';

function adjustImageSize(){
  const ar=img.naturalWidth/img.naturalHeight, scaleFactor=.85;
  if (canvas.width/canvas.height>ar){ imgWidth=canvas.height*ar*scaleFactor; imgHeight=canvas.height*scaleFactor; }
  else{ imgWidth=canvas.width*scaleFactor; imgHeight=(canvas.width/ar)*scaleFactor; }
  imgX=(canvas.width-imgWidth)/2; imgY=(canvas.height-imgHeight)/2; imgScale=1;
}
function positionResizeHandle(){
  resizeHandle.style.left=(imgX + (imgWidth*imgScale) - resizeHandle.clientWidth)+'px';
  resizeHandle.style.top =(imgY + (imgHeight*imgScale) - resizeHandle.clientHeight)+'px';
  resizeHandle.style.display='flex';
}
function drawImage(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(img.src) ctx.drawImage(img, imgX, imgY, imgWidth*imgScale, imgHeight*imgScale);
  ctx.lineWidth=2; ctx.strokeStyle="red"; if(img.src) ctx.strokeRect(imgX,imgY,imgWidth*imgScale,imgHeight*imgScale);
  positionResizeHandle();
}

img.onload=function(){ adjustImageSize(); drawImage(); positionResizeHandle(); resizeHandle.style.display='block'; };
document.getElementById('resetMap').addEventListener('click', ()=>{ adjustImageSize(); drawImage(); });

canvas.addEventListener('mousedown', e=>{ if(e.target===resizeHandle) return; startX=e.offsetX; startY=e.offsetY; dragging=true; });
canvas.addEventListener('mousemove', e=>{ if(dragging){ let dx=e.offsetX-startX, dy=e.offsetY-startY; imgX+=dx; imgY+=dy; startX=e.offsetX; startY=e.offsetY; drawImage(); } });
canvas.addEventListener('mouseup', ()=> dragging=false);
canvas.addEventListener('wheel', e=>{
  e.preventDefault();
  const z = e.deltaY>0 ? 0.95 : 1.05;
  const mx=e.offsetX, my=e.offsetY; const offX=mx-imgX, offY=my-imgY;
  imgX = mx - offX*z; imgY = my - offY*z; imgScale*=z; drawImage();
},{passive:false});

function getDistance(t1,t2){ const dx=t1.clientX-t2.clientX, dy=t1.clientY-t2.clientY; return Math.hypot(dx,dy); }

canvas.addEventListener('touchstart', e=>{
  e.preventDefault();
  if(e.touches.length===1){ startX=e.touches[0].clientX; startY=e.touches[0].clientY; dragging=true; }
  else if(e.touches.length===2){ lastTouchDistance=getDistance(e.touches[0], e.touches[1]); }
},{passive:false});

canvas.addEventListener('touchmove', e=>{
  e.preventDefault();
  if(e.touches.length===1 && dragging){
    let dx=e.touches[0].clientX-startX, dy=e.touches[0].clientY-startY;
    imgX+=dx; imgY+=dy; startX=e.touches[0].clientX; startY=e.touches[0].clientY; drawImage();
  } else if(e.touches.length===2){
    const t1=e.touches[0], t2=e.touches[1]; const nd=getDistance(t1,t2); const z=nd/lastTouchDistance; lastTouchDistance=nd;
    const cx=(t1.clientX+t2.clientX)/2, cy=(t1.clientY+t2.clientY)/2;
    imgX = cx - (cx - imgX)*z; imgY = cy - (cy - imgY)*z; imgScale*=z; drawImage();
  }
},{passive:false});
canvas.addEventListener('touchend', ()=> dragging=false);

resizeHandle.addEventListener('mousedown', startResize); resizeHandle.addEventListener('touchstart', startResize, {passive:false});
function startResize(e){
  e.preventDefault(); resizing=true;
  startX=(e.clientX || e.touches[0].clientX); startY=(e.clientY || e.touches[0].clientY);
  startWidth=imgWidth; startHeight=imgHeight;
  document.addEventListener('mousemove', resizeImage); document.addEventListener('mouseup', stopResize);
  document.addEventListener('touchmove', resizeImage, {passive:false}); document.addEventListener('touchend', stopResize);
}
function resizeImage(e){
  if(!resizing) return;
  let dx=(e.clientX || e.touches[0].clientX)-startX; let dy=(e.clientY || e.touches[0].clientY)-startY;
  imgWidth=Math.max(50, startWidth+dx); imgHeight=Math.max(50, startHeight+dy); drawImage();
}
function stopResize(){
  resizing=false;
  document.removeEventListener('mousemove', resizeImage); document.removeEventListener('mouseup', stopResize);
  document.removeEventListener('touchmove', resizeImage); document.removeEventListener('touchend', stopResize);
}

/* Upload */
const uploadBtn=document.getElementById('uploadMap');
if(uploadBtn){
  uploadBtn.addEventListener('click', ()=>{
    const fileInput=document.createElement('input'); fileInput.type='file'; fileInput.accept='image/*';
    fileInput.addEventListener('change', (ev)=>{
      const file=ev.target.files[0]; if(file){ const r=new FileReader(); r.onload=(e)=>{ img.src=e.target.result; }; r.readAsDataURL(file); }
    }); fileInput.click();
  });
}

/* ========= KOMPASA LOÄ¢IKA (nemainÄ«ta) ========= */
const compassContainer=document.getElementById('compassContainer');
const compassInner=document.getElementById('compassInner');
const compassScaleContainer=document.getElementById('compassScaleContainer');
const compassScaleInner=document.getElementById('compassScaleInner');
const compassNeedle=document.getElementById('compassNeedle');
const toggleRotationModeButton=document.getElementById('toggleRotationMode');
const lockRotationModeButton=document.getElementById('lockRotationMode');
const resetCompassButton=document.getElementById('resetCompass');

const initialCompassLeft=550, initialCompassTop=60, initialGlobalScale=1, initialBaseRotation=0, initialScaleRotation=70;

let compassIsDragging=false, compassDragStartX=0, compassDragStartY=0;
let compassStartLeft=0, compassStartTop=0;
let activeRotationTarget='compassInner';
let isTouchingCompass=false, touchStartX=0, touchStartY=0, isRotationLocked=false;
let globalScale=1, baseRotation=0, scaleRotation=70;
let lastRotation=0;

function getAngle(t1,t2){ const dx=t2.clientX-t1.clientX, dy=t2.clientY-t1.clientY; return Math.atan2(dy,dx)*(180/Math.PI); }

if(toggleRotationModeButton){
  toggleRotationModeButton.addEventListener('click', ()=>{
    activeRotationTarget = activeRotationTarget==='compassInner' ? 'compassScaleInner' : 'compassInner';
    toggleRotationModeButton.classList.toggle('active', activeRotationTarget!=='compassInner');
  });
}

if(lockRotationModeButton){
  lockRotationModeButton.addEventListener('click', ()=>{
    isRotationLocked=!isRotationLocked;
    lockRotationModeButton.classList.toggle('active', isRotationLocked);
  });
}

if(resetCompassButton){
  resetCompassButton.addEventListener('click', ()=>{
    compassContainer.classList.add('with-transition');
    compassInner.classList.add('with-transition');
    compassScaleInner.classList.add('with-transition');
    compassScaleContainer.classList.add('with-transition');

    compassStartLeft=initialCompassLeft; compassStartTop=initialCompassTop; globalScale=initialGlobalScale; baseRotation=initialBaseRotation; scaleRotation=initialScaleRotation;
    updateCompassTransform();

    setTimeout(()=>{
      compassContainer.classList.remove('with-transition');
      compassInner.classList.remove('with-transition');
      compassScaleInner.classList.remove('with-transition');
      compassScaleContainer.classList.remove('with-transition');
    },500);
  });
}

function updateCompassTransform(){
  compassContainer.style.left=compassStartLeft+'px';
  compassContainer.style.top =compassStartTop +'px';
  compassScaleContainer.style.transform='scale('+globalScale+')';
  compassInner.style.transform='rotate('+baseRotation+'deg)';
  compassScaleInner.style.transform='rotate('+scaleRotation+'deg)';
}
updateCompassTransform();

compassContainer.addEventListener('mousedown', e=>{
  e.preventDefault(); compassIsDragging=true;
  const rect = compassContainer.getBoundingClientRect();
  compassDragStartX=e.clientX-rect.left; compassDragStartY=e.clientY-rect.top; e.stopPropagation();
});
document.addEventListener('mousemove', e=>{
  if(!compassIsDragging) return;
  compassStartLeft = e.clientX - compassDragStartX;
  compassStartTop  = e.clientY - compassDragStartY;
  updateCompassTransform();
});
document.addEventListener('mouseup', ()=> compassIsDragging=false);

/* Touch uz kompasu: drag, pinch zoom, rotate */
compassContainer.addEventListener('touchstart', e=>{
  e.preventDefault();
  if(e.touches.length===1){
    isTouchingCompass=true; touchStartX=e.touches[0].clientX; touchStartY=e.touches[0].clientY;
    compassDragStartX=e.touches[0].clientX - compassStartLeft;
    compassDragStartY=e.touches[0].clientY - compassStartTop;
  } else if(e.touches.length===2){
    lastTouchDistance=getDistance(e.touches[0], e.touches[1]);
    lastRotation=getAngle(e.touches[0], e.touches[1]);
  }
},{passive:false});

compassContainer.addEventListener('touchmove', e=>{
  e.preventDefault();
  if(e.touches.length===1 && isTouchingCompass){
    compassStartLeft = e.touches[0].clientX - compassDragStartX;
    compassStartTop  = e.touches[0].clientY - compassDragStartY;
    updateCompassTransform();
  } else if(e.touches.length===2){
    const nd=getDistance(e.touches[0], e.touches[1]);
    globalScale *= nd/lastTouchDistance; lastTouchDistance=nd;
    if(!isRotationLocked){
      const nr=getAngle(e.touches[0], e.touches[1]);
      if(activeRotationTarget==='compassInner') baseRotation += nr-lastRotation;
      else scaleRotation += nr-lastRotation;
      lastRotation=nr;
    }
    updateCompassTransform();
  }
},{passive:false});
compassContainer.addEventListener('touchend', ()=> isTouchingCompass=false);

/* RiteÅ†a Ä«sceÄ¼i uz kompasu (rotÄcija/mÄ“rogs) */
compassContainer.addEventListener('wheel', (e)=>{
  e.preventDefault();
  if(e.shiftKey){ baseRotation += e.deltaY*0.005; }
  else if(e.altKey){ globalScale += e.deltaY * -0.0005; globalScale=Math.min(Math.max(.5,globalScale),5); }
  else if(e.ctrlKey){ scaleRotation += e.deltaY*0.005; }
  updateCompassTransform();
},{passive:false});
document.addEventListener('keydown', (e)=>{
  if(e.key==='ArrowLeft') baseRotation-=5;
  else if(e.key==='ArrowRight') baseRotation+=5;
  else if(e.key==='ArrowUp') scaleRotation+=5;
  else if(e.key==='ArrowDown') scaleRotation-=5;
  updateCompassTransform();
});
window.addEventListener('load', ()=>{
  compassStartLeft=initialCompassLeft; compassStartTop=initialCompassTop; updateCompassTransform();
});

/* ========= PILNEKRÄ€NS (nemainÄ«ts â€“ saÄ«sinÄts) ========= */
(function(){
  const toggleFullscreenButton=document.getElementById('toggleFullscreen');
  const fullscreenIcon=document.getElementById('fullscreenIcon');
  const fullscreenPopup=document.getElementById('fullscreenPopup');
  const enterIcon='https://site-710050.mozfiles.com/files/710050/fulscreen.png';
  const exitIcon ='https://site-710050.mozfiles.com/files/710050/fulscreen_exit.png';
  if(fullscreenIcon) fullscreenIcon.src=enterIcon;

  function isFS(){ return document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement; }
  function enterFS(el){ (el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen||el.mozRequestFullScreen).call(el); }
  function exitFS(){ (document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen||document.mozCancelFullScreen).call(document); }
  function showFS(msg, cls){ fullscreenPopup.textContent=msg; fullscreenPopup.className=''; fullscreenPopup.classList.add(cls); fullscreenPopup.style.display='block'; setTimeout(()=>fullscreenPopup.style.display='none', 4000); }
  function updateBtn(){ if(isFS()){ if(fullscreenIcon) fullscreenIcon.src=exitIcon; showFS('PilnekrÄna reÅ¾Ä«ms ieslÄ“gts','popup-success'); } else { if(fullscreenIcon) fullscreenIcon.src=enterIcon; showFS('PilnekrÄna reÅ¾Ä«ms izslÄ“gts','popup-error'); } }

  if(toggleFullscreenButton){
    toggleFullscreenButton.addEventListener('click', ()=>{
      const el=document.documentElement;
      if(!isFS()) enterFS(el); else exitFS();
    });
  }
  document.addEventListener('fullscreenchange', updateBtn);
  document.addEventListener('webkitfullscreenchange', updateBtn);
  document.addEventListener('mozfullscreenchange', updateBtn);
  document.addEventListener('MSFullscreenChange', updateBtn);
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') exitFS(); });
  window.addEventListener('visibilitychange', ()=>{ if(!document.hidden) updateBtn(); });
})();

/* ========= DROPDOWNI (nemainÄ«ti â€“ saÄ«sinÄti) ========= */
document.getElementById("toggleMaterials").addEventListener("click", function(){
  let menu=document.getElementById("dropdownMaterials"); let btn=this;
  menu.classList.toggle("visible"); btn.classList.toggle("active");
});
document.getElementById("toggleInstruction").addEventListener("click", function(){
  let menu=document.getElementById("dropdownInstruction"); let btn=this;
  menu.classList.toggle("visible"); btn.classList.toggle("active");
});
document.addEventListener("click", function(e){
  let iM=document.getElementById("dropdownInstruction"), mM=document.getElementById("dropdownMaterials");
  let iB=document.getElementById("toggleInstruction"), mB=document.getElementById("toggleMaterials");
  if(!iM.contains(e.target) && !iB.contains(e.target)){ iM.classList.remove("visible"); iB.classList.remove("active"); }
  if(!mM.contains(e.target) && !mB.contains(e.target)){ mM.classList.remove("visible"); mB.classList.remove("active"); }
});
document.querySelectorAll('#dropdownMaterials a').forEach(a=>{
  a.addEventListener('click', function(ev){
    ev.preventDefault(); let iframe=document.getElementById('contentFrame'); let menus=document.querySelectorAll('.dropdown-menu');
    iframe.style.display='block'; iframe.classList.add('active'); iframe.src=this.getAttribute('href'); menus.forEach(m=>m.classList.add('shrink'));
  });
});
document.getElementById("toggleMaterials").addEventListener("click", function(){
  let iframe=document.getElementById('contentFrame'); let menus=document.querySelectorAll('.dropdown-menu');
  iframe.classList.remove('active'); setTimeout(()=>{ iframe.style.display='none'; iframe.src=""; },300); menus.forEach(m=>m.classList.remove('shrink'));
});
document.querySelectorAll('#dropdownInstruction a').forEach(a=>{
  a.addEventListener('click', function(ev){
    ev.preventDefault(); let iframe=document.getElementById('instructionFrame'); let menu=document.getElementById('dropdownInstruction');
    iframe.style.display='block'; iframe.classList.add('active'); iframe.src=this.getAttribute('href'); menu.classList.add('shrink');
  });
});
document.getElementById("toggleInstruction").addEventListener("click", function(){
  let iframe=document.getElementById('instructionFrame'); let menu=document.getElementById('dropdownInstruction');
  iframe.classList.remove('active'); setTimeout(()=>{ iframe.style.display='none'; iframe.src=""; },300); menu.classList.remove('shrink');
});

/* ========= ABOUT/QR (nemainÄ«ts) ========= */
function toggleIframeAbout(ev){ if(ev) ev.preventDefault(); let c=document.getElementById("iframeContainerAbout"); let st=getComputedStyle(c);
  if(st.display==="none" || st.bottom==="-620px"){ c.style.display="block"; setTimeout(()=>{ c.style.bottom="35px"; },10); }
  else { c.style.bottom="-620px"; setTimeout(()=>{ c.style.display="none"; },500); } }
function toggleIframeQR(ev){ if(ev) ev.preventDefault(); let c=document.getElementById("iframeContainerQR"); let st=getComputedStyle(c);
  if(st.display==="none" || st.bottom==="-370px"){ c.style.display="block"; setTimeout(()=>{ c.style.bottom="35px"; },10); }
  else { c.style.bottom="-370px"; setTimeout(()=>{ c.style.display="none"; },500); } }
document.addEventListener("DOMContentLoaded", function(){ let c=document.getElementById("iframeContainerAbout"); c.style.display="none"; c.style.bottom="-220px";
  let q=document.getElementById("iframeContainerQR"); q.style.display="none"; q.style.bottom="-370px";
});

/* ========= POZÄªCIJAS IZVÄ’LNE (nemainÄ«ta, bet strÄdÄ ar JAUNO dok-u) ========= */
function closeBothMenus(){
  document.querySelector('.position-selector-left').classList.add('hidden-left');
  document.querySelector('.position-selector').classList.add('hidden');
  document.querySelector('.toggle-selector-left').textContent='â¯';
  document.querySelector('.toggle-selector').textContent='â®';
}
document.querySelector('.toggle-selector').addEventListener('click', ()=>{
  const sel=document.querySelector('.position-selector');
  if(sel.classList.contains('hidden')){ sel.classList.remove('hidden'); document.querySelector('.toggle-selector').textContent='â¯'; }
  else closeBothMenus();
});
document.querySelector('.toggle-selector-left').addEventListener('click', ()=>{
  const sel=document.querySelector('.position-selector-left');
  if(sel.classList.contains('hidden-left')){ sel.classList.remove('hidden-left'); document.querySelector('.toggle-selector-left').textContent='â®'; }
  else closeBothMenus();
});
function syncSelectOptions(val){ document.getElementById('positionSelectLeft').value=val; document.getElementById('positionSelect').value=val; }
function updateButtonContainerPosition(position){
  const buttonContainer=document.getElementById('buttonContainer');
  buttonContainer.classList.remove('bottom','right','left');
  buttonContainer.classList.add(position);
}
document.getElementById('positionSelectLeft').addEventListener('change', ()=>{
  const v=document.getElementById('positionSelectLeft').value; syncSelectOptions(v); closeBothMenus(); updateButtonContainerPosition(v); localStorage.setItem('buttonPosition', v);
});
document.getElementById('positionSelect').addEventListener('change', ()=>{
  const v=document.getElementById('positionSelect').value; syncSelectOptions(v); closeBothMenus(); updateButtonContainerPosition(v); localStorage.setItem('buttonPosition', v);
});
document.addEventListener('DOMContentLoaded', ()=>{
  const leftSel=document.querySelector('.position-selector-left'); if(!leftSel.classList.contains('hidden-left')) leftSel.classList.add('hidden-left');
  const saved=localStorage.getItem('buttonPosition'); if(saved) updateButtonContainerPosition(saved);
});

/* ========= JAUNÄ€ DOKA LOÄ¢IKA (kupols + etiÄ·ete + klikÅ¡Ä·i uz legacy pogÄm) ========= */
(function(){
  const dock   = document.getElementById('dock');
  const label  = document.getElementById('dockLabel');
  const capSVG = document.getElementById('dockCap');
  const btns   = [...dock.querySelectorAll('.dock-btn')];

  function updateCapGeometry(){
    const cs=getComputedStyle(dock);
    const labelW=parseFloat(cs.getPropertyValue('--labelW'))||0;
    const extra =parseFloat(cs.getPropertyValue('--capExtraW'))||0;
    const w=labelW+22+extra;
    const h=parseFloat(cs.getPropertyValue('--capH'))||0;
    const inset=parseFloat(cs.getPropertyValue('--capSkew'))||0;
    const r=parseFloat(cs.getPropertyValue('--capR'))||0;
    if(!w||!h) return;

    const TLx=inset+r, TRx=w-inset-r;
    const LEx=inset, LEy=r;
    const REx=w-inset, REy=r;

    const sideMidY=r+(h-r)*0.45;
    const rightCP1x=REx+(w-REx)*0.18, rightCP1y=sideMidY;
    const rightCP2x=w, rightCP2y=r+(h-r)*0.82;
    const leftCP2x=0, leftCP2y=r+(h-r)*0.82;
    const leftCP1x=LEx - (LEx-0)*0.18, leftCP1y=sideMidY;

    capSVG.setAttribute('viewBox', \`0 0 \${w} \${h}\`);
    capSVG.setAttribute('width', w); capSVG.setAttribute('height', h);
    capSVG.innerHTML = \`
      <defs>
        <linearGradient id="capFill" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="rgba(40,44,52,.96)"/>
          <stop offset="100%" stop-color="rgba(30,33,40,.96)"/>
        </linearGradient>
        <radialGradient id="capShine" cx="50%" cy="-30%" r="120%">
          <stop offset="0%" stop-color="rgba(255,255,255,.18)"/>
          <stop offset="60%" stop-color="rgba(255,255,255,0)"/>
        </radialGradient>
      </defs>
      <path d="
        M \${TLx},0 H \${TRx}
        A \${r},\${r} 0 0 1 \${REx},\${REy}
        C \${rightCP1x},\${rightCP1y} \${rightCP2x},\${rightCP2y} \${w},\${h}
        L 0,\${h}
        C \${leftCP2x},\${leftCP2y} \${leftCP1x},\${leftCP1y} \${LEx},\${LEy}
        A \${r},\${r} 0 0 1 \${TLx},0 Z" fill="url(#capFill)" stroke="rgba(210,34,34,.38)" stroke-width="1" />
      <path d="
        M \${TLx},0 H \${TRx}
        A \${r},\${r} 0 0 1 \${REx},\${REy}
        C \${rightCP1x},\${rightCP1y} \${rightCP2x},\${rightCP2y} \${w},\${h}
        L 0,\${h}
        C \${leftCP2x},\${leftCP2y} \${leftCP1x},\${leftCP1y} \${LEx},\${LEy}
        A \${r},\${r} 0 0 1 \${TLx},0 Z" fill="url(#capShine)"/>
    \`;
  }

  let raf=null, targetX=null, currentX=null;
  function setTipX(px){
    targetX=px; if(currentX==null) currentX=px; if(raf) return;
    const step=()=>{ currentX += (targetX-currentX)*0.25; dock.style.setProperty('--tipX', \`\${currentX}px\`);
      if(Math.abs(targetX-currentX)>0.5) raf=requestAnimationFrame(step);
      else { currentX=targetX; dock.style.setProperty('--tipX', \`\${currentX}px\`); raf=null; }
    };
    raf=requestAnimationFrame(step);
  }
  function clampX(centerX){
    const rDock=dock.getBoundingClientRect();
    const cs=getComputedStyle(dock);
    const padL=parseFloat(cs.paddingLeft)||18, padR=parseFloat(cs.paddingRight)||18;
    const radL=parseFloat(cs.borderTopLeftRadius)||48, radR=parseFloat(cs.borderTopRightRadius)||48;

    const labelW=Math.min(label.scrollWidth+2, rDock.width-40);
    dock.style.setProperty('--labelW', \`\${labelW}px\`);
    const capH=label.offsetHeight+2; dock.style.setProperty('--capH', \`\${capH}px\`);
    updateCapGeometry();

    const extra=parseFloat(cs.getPropertyValue('--capExtraW'))||0;
    const capW=labelW+22+extra; const safe=10;
    const minX=padL + radL/2 + capW/2 + safe;
    const maxX=rDock.width - (padR + radR/2 + capW/2 + safe);
    return Math.max(minX, Math.min(maxX, centerX));
  }
  function centerOf(btn){
    const rDock=dock.getBoundingClientRect();
    const rBtn=btn.getBoundingClientRect();
    return rBtn.left + rBtn.width/2 - rDock.left;
  }
  function moveTo(btn){
    label.textContent = btn.dataset.title || btn.ariaLabel || '';
    dock.classList.add('show-label','show-cap');
    const x=clampX(centerOf(btn)); setTipX(x);
  }

  dock.addEventListener('pointerenter', e=>{ moveTo(e.target.closest('.dock-btn')||btns[0]); });
  dock.addEventListener('pointerleave', ()=>{ dock.classList.remove('show-label','show-cap'); });
  dock.addEventListener('pointermove', e=>{
    let best=null, bestD=Infinity, x=e.clientX;
    for(const b of btns){ const cx=b.getBoundingClientRect().left + b.offsetWidth/2; const d=Math.abs(cx-x); if(d<bestD){ bestD=d; best=b; } }
    if(best) moveTo(best);
  });
  dock.addEventListener('focusin', e=>{ const b=e.target.closest('.dock-btn'); if(b) moveTo(b); });
  dock.addEventListener('focusout', e=>{ if(!dock.contains(e.relatedTarget)) dock.classList.remove('show-label','show-cap'); });
  let t; btns.forEach(b=> b.addEventListener('touchstart', ()=>{ moveTo(b); clearTimeout(t); t=setTimeout(()=>dock.classList.remove('show-label','show-cap'),1600); }, {passive:true}));

  /* KlikÅ¡Ä·i â†’ izsauc slÄ“ptÄs legacy pogas vai lokÄlo pÄrslÄ“gÅ¡anu */
  dock.addEventListener('click', e=>{
    const b=e.target.closest('.dock-btn'); if(!b) return;
    const a=b.dataset.action;
    if(a==='reset-map')      document.getElementById('resetMap').click();
    if(a==='reset-compass')  document.getElementById('resetCompass').click();
    if(a==='upload-map')     document.getElementById('uploadMap').click();
    if(a==='grid-view')      document.getElementById('rotateCompass90').click();
    if(a==='fullscreen')     document.getElementById('toggleFullscreen').click();

    if(a==='lock-rotation'){ document.getElementById('lockRotationMode').click(); }

    if(a==='toggle-rotate-target'){
      const tBtn=document.getElementById('toggleBtn'); const tIcon=document.getElementById('toggleIcon');
      // PÄrslÄ“dzam to paÅ¡u mainÄ«go, ko lieto Tava loÄ£ika
      activeRotationTarget = (activeRotationTarget==='compassInner') ? 'compassScaleInner' : 'compassInner';
      const txt=(activeRotationTarget==='compassInner')?'Griezt bÄzi':'Griezt skalu';
      tBtn.dataset.title=txt; tBtn.setAttribute('aria-label', txt);

      if(dock.classList.contains('show-label')){ label.textContent=txt; const x=clampX(centerOf(tBtn)); setTipX(x); }

      tIcon.style.transition='transform .18s ease, opacity .18s ease';
      tIcon.style.transform='scale(.92) rotate(-8deg)'; tIcon.style.opacity='.85';
      setTimeout(()=>{
        tIcon.innerHTML=(activeRotationTarget==='compassInner')
          ? '<polygon points="12 2 22 22 2 22 12 2"></polygon>'
          : '<circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path>';
        tIcon.style.transform='scale(1) rotate(0)'; tIcon.style.opacity='1';
      },120);
    }
  });

  addEventListener('resize', ()=> dock.classList.remove('show-label','show-cap'));
})();
</script>
</body>
</html>
    `);

    interactiveWindow.document.close();
  });
  </script>
</body>
</html>
